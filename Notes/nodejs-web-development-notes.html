<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Node.js & Web Development Study Notes</title>
  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="../assets/css/main.css" />
</head>
<body>
  <!-- Sidebar Navigation -->
  <button class="sidebar-toggle" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
  <div class="sidebar-overlay" onclick="closeSidebar()"></div>
  
  <div class="layout-container">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <h3><i class="fas fa-books"></i> Course Navigation</h3>
        <p>Node.js & Web Development</p>
      </div>
      <div class="sidebar-content">
        <ul>
          <li>
            <a href="#outline" onclick="closeSidebar()"><i class="fas fa-clipboard"></i> Course Outline</a>
          </li>
          <li>
            <a href="#lesson1" onclick="closeSidebar()"><i class="fas fa-star"></i> Node.js Fundamentals</a>
          </li>
          <li>
            <a href="#lesson2" onclick="closeSidebar()"><i class="fas fa-sync"></i> Event Loop & Concurrency</a>
          </li>
          <li>
            <a href="#lesson3" onclick="closeSidebar()"><i class="fas fa-box"></i> Modules & NPM</a>
          </li>
          <li>
            <a href="#lesson4" onclick="closeSidebar()"><i class="fas fa-globe"></i> Web Concepts</a>
          </li>
          <li>
            <a href="#lesson5" onclick="closeSidebar()"><i class="fas fa-lock"></i> Security Concepts</a>
          </li>
          <li>
            <a href="#lesson6" onclick="closeSidebar()"><i class="fas fa-rocket"></i> Express.js</a>
          </li>
          <li>
            <a href="#lesson7" onclick="closeSidebar()"><i class="fas fa-star"></i> Working with Databases</a>
          </li>
          <li>
            <a href="#lesson8" onclick="closeSidebar()"><i class="fas fa-lock"></i> Authentication & Authorization</a>
          </li>
          <li>
            <a href="#lesson9" onclick="closeSidebar()"><i class="fas fa-tools"></i> Advanced Topics</a>
          </li>
        </ul>
      </div>
    </aside>
    <!-- Main Content -->
    <main class="main-content">
      <div class="container" id="mainContainer">
        <a href="../index.html" class="back-button"><i class="fas fa-arrow-left"></i> Back to Main Page</a><div class="header">
          <h1><i class="fas fa-star"></i> Node.js & Web Development</h1>
          <p>Comprehensive Study Guide & Notes</p>
        </div>
        <section id="outline" class="course-outline">
          <h2><i class="fas fa-books"></i> Course Outline</h2>
          <div class="lesson-list">
            <div class="lesson-item">
              <strong>Module 1:</strong> Node.js Fundamentals
            </div>
            <div class="lesson-item">
              <strong>Module 2:</strong> Event Loop & Concurrency Model
            </div>
            <div class="lesson-item">
              <strong>Module 3:</strong> Modules & NPM
            </div>
            <div class="lesson-item">
              <strong>Module 4:</strong> Web Concepts (HTTP, URLs, REST)
            </div>
            <div class="lesson-item">
              <strong>Module 5:</strong> Security Concepts
            </div>
            <div class="lesson-item">
              <strong>Module 6:</strong> Express.js Framework
            </div>
            <div class="lesson-item">
              <strong>Module 7:</strong> Working with Databases
            </div>
            <div class="lesson-item">
              <strong>Module 8:</strong> Authentication & Authorization
            </div>
            <div class="lesson-item">
              <strong>Module 9:</strong> Advanced Topics (Middleware, Error Handling, Testing)
            </div>
          </div>
        </section>
        <div id="lesson1" class="lesson">
          <div class="lesson-header">
            <h2>Module 1: Node.js Fundamentals</h2>
          </div>
          <div class="lesson-content">
            <div class="section">
              <h3 class="section-title">1.1 What is Node.js?</h3>
              <div class="definition-box">
                <p>
                  <strong>Node.js</strong> is an open-source, cross-platform runtime environment that allows
                  developers to execute JavaScript code outside of a web browser. It's designed for building
                  high-performance, scalable network applications.
                </p>
              </div>
              <div class="highlight-box">
                <p><strong>Key Characteristics:</strong></p>
                <ul>
                  <li><i class="fas fa-globe"></i> <strong>JavaScript Everywhere:</strong> Use the same language for both frontend and backend
                  </li>
                  <li><i class="fas fa-bolt"></i> <strong>Built on V8:</strong> Uses Google's V8 JavaScript engine for fast execution</li>
                  <li><i class="fas fa-sync"></i> <strong>Asynchronous & Event-Driven:</strong> Non-blocking I/O for high performance</li>
                  <li><i class="fas fa-box"></i> <strong>Rich Ecosystem:</strong> Access to over 1 million packages via NPM</li>
                  <li><i class="fas fa-rocket"></i> <strong>High Performance:</strong> Handles thousands of concurrent connections efficiently</li>
                  <li><i class="fas fa-random"></i> <strong>Single-Threaded:</strong> Uses event loop for concurrency (but can spawn worker
                    threads)</li>
                </ul>
              </div>
            </div>
            <div class="section">
              <h3 class="section-title">1.2 Node.js Architecture</h3>
              <table class="comparison-table">
                <thead>
                  <tr>
                    <th>Component</th>
                    <th>Technology</th>
                    <th>Role</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td><strong>JS Execution</strong></td>
                    <td>Chrome V8 Engine</td>
                    <td>Compiles and executes JavaScript code at high speed</td>
                  </tr>
                  <tr>
                    <td><strong>Asynchronous I/O</strong></td>
                    <td>libuv</td>
                    <td>Handles async I/O operations (file system, network, timers)</td>
                  </tr>
                  <tr>
                    <td><strong>Event Loop</strong></td>
                    <td>libuv</td>
                    <td>Manages the execution of async callbacks</td>
                  </tr>
                  <tr>
                    <td><strong>Standard Library</strong></td>
                    <td>JavaScript</td>
                    <td>Core modules (fs, http, path, crypto, etc.)</td>
                  </tr>
                  <tr>
                    <td><strong>Bindings</strong></td>
                    <td>C/C++</td>
                    <td>Low-level operations (http, sockets, file system)</td>
                  </tr>
                </tbody>
              </table>
              <div class="code-box">
                <pre>
<strong>Node.js Architecture Diagram:</strong>
+-----------------------------------------------------+
�              JavaScript Application Code            �
�         (Your Node.js Application Code)             �
+-----------------------------------------------------+
                     �
+-----------------------------------------------------+
�           Node.js Standard Library (JS)             �
�   (fs, http, crypto, path, os, events, etc.)        �
+-----------------------------------------------------+
                     �
+-----------------------------------------------------+
�             Node.js Bindings (C/C++)                �
�    (Interface between JS and C++ libraries)         �
+-----------------------------------------------------+
                     �
        +---------------------------+
        �                           �
+----------------+          +----------------+
�   V8 Engine    �          �     libuv      �
�   (Google)     �          �  (Event Loop,  �
�  - Compiles &  �          �   Async I/O,   �
�    Executes JS �          �  Thread Pool)  �
+----------------+          +----------------+
        �                           �
        +---------------------------+
                     �
+-----------------------------------------------------+
�            Operating System (Windows/Linux/Mac)     �
+-----------------------------------------------------+
</pre>
              </div>
            </div>
            <div class="section">
              <h3 class="section-title">1.3 Advantages of Node.js</h3>
              <div class="component-grid">
                <div class="component-card">
                  <h4><i class="fas fa-bolt"></i> Performance</h4>
                  <p>V8 engine compiles JavaScript to machine code for fast execution</p>
                </div>
                <div class="component-card">
                  <h4><i class="fas fa-star"></i> Scalability</h4>
                  <p>Handles thousands of concurrent connections with minimal overhead</p>
                </div>
                <div class="component-card">
                  <h4><i class="fas fa-sync"></i> Non-Blocking I/O</h4>
                  <p>Asynchronous operations prevent blocking the main thread</p>
                </div>
                <div class="component-card">
                  <h4><i class="fas fa-globe"></i> Full-Stack JavaScript</h4>
                  <p>Same language for frontend and backend development</p>
                </div>
                <div class="component-card">
                  <h4><i class="fas fa-box"></i> Rich Ecosystem</h4>
                  <p>NPM provides access to 1M+ open-source packages</p>
                </div>
                <div class="component-card">
                  <h4><i class="fas fa-rocket"></i> Fast Development</h4>
                  <p>Rapid prototyping and development cycles</p>
                </div>
                <div class="component-card">
                  <h4><i class="fas fa-random"></i> Cross-Platform</h4>
                  <p>Runs on Windows, Linux, macOS, and more</p>
                </div>
                <div class="component-card">
                  <h4><i class="fas fa-users"></i> Large Community</h4>
                  <p>Active community with extensive documentation and support</p>
                </div>
              </div>
            </div>
            <div class="section">
              <h3 class="section-title">1.4 Node.js Use Cases</h3>
              <div class="example-box">
                <h5><i class="fas fa-check"></i> Ideal For:</h5>
                <ul>
                  <li><i class="fas fa-globe"></i> <strong>RESTful APIs:</strong> Backend services for web and mobile apps</li>
                  <li><i class="fas fa-star"></i> <strong>Real-Time Applications:</strong> Chat apps, collaborative tools, live updates</li>
                  <li><i class="fas fa-gamepad"></i> <strong>WebSocket Servers:</strong> Gaming, multiplayer apps</li>
                  <li><i class="fas fa-chart-bar"></i> <strong>Data Streaming:</strong> Video/audio streaming platforms</li>
                  <li><i class="fas fa-bell"></i> <strong>Event-Driven Applications:</strong> Notification systems</li>
                  <li><i class="fas fa-tools"></i> <strong>Microservices:</strong> Scalable distributed systems</li>
                  <li><i class="fas fa-mobile-alt"></i> <strong>IoT Applications:</strong> Connected devices and sensors</li>
                  <li><i class="fas fa-star"></i> <strong>Serverless Functions:</strong> AWS Lambda, Azure Functions</li>
                </ul>
              </div>
              <div class="warning-box">
                <strong>Not Ideal For:</strong>
                <ul>
                  <li><i class="fas fa-exclamation-triangle"></i> CPU-Intensive Tasks (image processing, video encoding, complex calculations)</li>
                  <li><i class="fas fa-exclamation-triangle"></i> Heavy Computational Work (machine learning, scientific computing)</li>
                  <li><i class="fas fa-exclamation-triangle"></i> Applications requiring multi-threading for computation</li>
                </ul>
                <p><strong>Solution:</strong> For CPU-intensive tasks, use Worker Threads or delegate to specialized
                  services.</p>
              </div>
            </div>
            <div class="section">
              <h3 class="section-title">1.5 Installing and Running Node.js</h3>
              <div class="node-command">
                <pre><span class="comment"># Check if Node.js is installed</span>
<span class="prompt">$</span> node --version
v20.10.0
<span class="comment"># Check NPM version</span>
<span class="prompt">$</span> npm --version
10.2.3
<span class="comment"># Run JavaScript file</span>
<span class="prompt">$</span> node app.js
<span class="comment"># Open Node.js REPL (Read-Eval-Print Loop)</span>
<span class="prompt">$</span> node
<span class="prompt">></span> console.log("Hello Node.js!")
Hello Node.js!
<span class="prompt">></span> const sum = (a, b) => a + b
<span class="prompt">></span> sum(5, 3)
8
<span class="prompt">></span> .exit  <span class="comment">// Exit REPL</span>
</pre>
              </div>
              <div class="example-box">
                <h5>Example: Hello World Server</h5>
                <div class="code-box">
                  <pre><span class="comment">// server.js</span>
const http = require('http');
const server = http.createServer((req, res) => {
  res.statusCode = 200;
  res.setHeader('Content-Type', 'text/plain');
  res.end('Hello World from Node.js!\n');
});
const PORT = 3000;
server.listen(PORT, () => {
  console.log(`Server running at http://localhost:${PORT}/`);
});
</pre>
                </div>
                <div class="node-command">
                  <pre><span class="comment"># Run the server</span>
<span class="prompt">$</span> node server.js
Server running at http://localhost:3000/
</pre>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div id="lesson2" class="lesson">
          <div class="lesson-header">
            <h2>Module 2: Event Loop & Concurrency Model</h2>
          </div>
          <div class="lesson-content">
            <div class="section">
              <h3 class="section-title">2.1 Understanding the Event Loop</h3>
              <div class="definition-box">
                <p>
                  The <strong>Event Loop</strong> is the heart of Node.js's asynchronous, non-blocking architecture.
                  It's a single-threaded mechanism that manages the execution of code, handles events, and processes
                  queued callbacks.
                </p>
              </div>
              <div class="code-box">
                <pre>
<strong>Event Loop Phases:</strong>
   +---------------------------+
+->�           timers          �  Execute setTimeout & setInterval callbacks
�  +---------------------------+
�  +---------------------------+
�  �     pending callbacks     �  Execute I/O callbacks deferred to next loop
�  +---------------------------+
�  +---------------------------+
�  �       idle, prepare       �  Internal use only
�  +---------------------------+      +---------------+
�  +---------------------------+      �   incoming:   �
�  �           poll            �<-----�  connections, �
�  �                           �      �   data, etc.  �
�  +---------------------------+      +---------------+
�  +---------------------------+
�  �           check           �  Execute setImmediate() callbacks
�  +---------------------------+
�  +---------------------------+
+--�      close callbacks      �  Execute close event callbacks (e.g., socket.on('close'))
   +---------------------------+
</pre>
              </div>
              <div class="subsection">
                <h4 class="subsection-title">Phase Descriptions</h4>
                <table class="comparison-table">
                  <thead>
                    <tr>
                      <th>Phase</th>
                      <th>Description</th>
                      <th>Example</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td><strong>Timers</strong></td>
                      <td>Executes callbacks scheduled by setTimeout() and setInterval()</td>
                      <td><code>setTimeout(() => console.log('timer'), 100)</code></td>
                    </tr>
                    <tr>
                      <td><strong>Pending Callbacks</strong></td>
                      <td>Executes I/O callbacks deferred from previous iteration</td>
                      <td>TCP errors, etc.</td>
                    </tr>
                    <tr>
                      <td><strong>Poll</strong></td>
                      <td>Retrieve new I/O events; execute I/O callbacks (most code runs here)</td>
                      <td>File reads, network requests</td>
                    </tr>
                    <tr>
                      <td><strong>Check</strong></td>
                      <td>Executes setImmediate() callbacks</td>
                      <td><code>setImmediate(() => console.log('immediate'))</code></td>
                    </tr>
                    <tr>
                      <td><strong>Close Callbacks</strong></td>
                      <td>Executes close event callbacks</td>
                      <td><code>socket.on('close', callback)</code></td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="section">
              <h3 class="section-title">2.2 Multi-Threaded vs Event Loop</h3>
              <table class="comparison-table">
                <thead>
                  <tr>
                    <th>Aspect</th>
                    <th>Multi-Threaded Server (Java, C++)</th>
                    <th>Node.js Event Loop (Single-Threaded)</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td><strong>Thread Model</strong></td>
                    <td>Creates new thread for each request<br>Thread pool manages threads</td>
                    <td>Single thread handles all JavaScript execution<br>libuv thread pool handles I/O</td>
                  </tr>
                  <tr>
                    <td><strong>I/O Handling</strong></td>
                    <td>Each thread blocks while waiting for I/O<br>Context switching overhead</td>
                    <td>Non-blocking I/O<br>Callbacks executed when I/O completes</td>
                  </tr>
                  <tr>
                    <td><strong>Memory Usage</strong></td>
                    <td>High (each thread needs stack space)<br>~1MB per thread</td>
                    <td>Low (single thread for JS execution)<br>Much smaller memory footprint</td>
                  </tr>
                  <tr>
                    <td><strong>Concurrency</strong></td>
                    <td>Limited by thread count<br>Heavy context switching</td>
                    <td>Handles thousands of connections<br>Event-driven, no context switching</td>
                  </tr>
                  <tr>
                    <td><strong>Scalability</strong></td>
                    <td>Vertical scaling (more CPU/RAM)<br>Thread overhead limits scalability</td>
                    <td>Horizontal scaling (more instances)<br>Lightweight, scales easily</td>
                  </tr>
                  <tr>
                    <td><strong>Best For</strong></td>
                    <td>CPU-intensive tasks<br>Parallel computations</td>
                    <td>I/O-intensive tasks<br>Real-time applications</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="section">
              <h3 class="section-title">2.3 Microtasks vs Macrotasks</h3>
              <div class="definition-box">
                <p>
                  Node.js has two types of task queues with different priorities:
                </p>
                <ul>
                  <li><strong>Microtasks</strong> (higher priority): process.nextTick(), Promise callbacks</li>
                  <li><strong>Macrotasks</strong> (lower priority): setTimeout(), setInterval(), setImmediate()</li>
                </ul>
              </div>
              <div class="example-box">
                <h5>Example: Execution Order</h5>
                <div class="code-box">
                  <pre>console.log('1: Synchronous');
setTimeout(() => {
  console.log('2: setTimeout (macrotask)');
}, 0);
setImmediate(() => {
  console.log('3: setImmediate (macrotask)');
});
Promise.resolve().then(() => {
  console.log('4: Promise (microtask)');
});
process.nextTick(() => {
  console.log('5: process.nextTick (microtask - highest priority)');
});
console.log('6: Synchronous');
<span class="comment">// Output:</span>
// 1: Synchronous
// 6: Synchronous
// 5: process.nextTick (microtask - highest priority)
// 4: Promise (microtask)
// 2: setTimeout (macrotask)
// 3: setImmediate (macrotask)
<span class="comment">// Execution Order:</span>
// 1. All synchronous code
// 2. process.nextTick() queue (microtask - highest priority)
// 3. Promise microtasks
// 4. Macrotasks (setTimeout, setImmediate)</span>
</pre>
                </div>
              </div>
              <div class="example-box">
                <h5>Example: Complex Event Loop Flow</h5>
                <div class="code-box">
                  <pre>const fs = require('fs');
console.log('Start');
setTimeout(() => console.log('Timeout 1'), 0);
setImmediate(() => console.log('Immediate 1'));
fs.readFile(__filename, () => {
  console.log('File read complete');
  setTimeout(() => console.log('Timeout 2'), 0);
  setImmediate(() => console.log('Immediate 2'));
  process.nextTick(() => console.log('NextTick inside file read'));
});
Promise.resolve().then(() => console.log('Promise 1'));
process.nextTick(() => console.log('NextTick 1'));
console.log('End');
<span class="comment">// Output:</span>
// Start
// End
// NextTick 1
// Promise 1
// Timeout 1
// Immediate 1
// File read complete
// NextTick inside file read
// Immediate 2
// Timeout 2
<span class="comment">// Why this order?
// 1. Synchronous: Start, End
// 2. Microtasks: NextTick 1, Promise 1
// 3. Timers phase: Timeout 1
// 4. Check phase: Immediate 1
// 5. Poll phase: File read completes
// 6. Microtasks after file read: NextTick inside file read
// 7. Check phase: Immediate 2 (immediately after I/O)
// 8. Timers phase: Timeout 2</span>
</pre>
                </div>
              </div>
            </div>
            <div class="section">
              <h3 class="section-title">2.4 Blocking vs Non-Blocking Code</h3>
              <div class="example-box">
                <h5><i class="fas fa-times"></i> Blocking Code (Synchronous)</h5>
                <div class="code-box">
                  <pre>const fs = require('fs');
console.log('Reading file...');
<span class="comment">// BLOCKS the event loop - BAD!</span>
const data = fs.readFileSync('large-file.txt', 'utf8');
console.log('File content:', data);
console.log('Done');
<span class="comment">// Problem: Event loop is blocked while reading file
// Can't handle other requests during this time</span>
</pre>
                </div>
              </div>
              <div class="example-box">
                <h5><i class="fas fa-check"></i> Non-Blocking Code (Asynchronous)</h5>
                <div class="code-box">
                  <pre>const fs = require('fs');
console.log('Reading file...');
<span class="comment">// NON-BLOCKING - GOOD!</span>
fs.readFile('large-file.txt', 'utf8', (err, data) => {
  if (err) {
    console.error('Error:', err);
    return;
  }
  console.log('File content:', data);
});
console.log('Done - Event loop continues!');
<span class="comment">// Output:
// Reading file...
// Done - Event loop continues!
// File content: [file contents]
// Event loop remains free to handle other requests!</span>
</pre>
                </div>
              </div>
              <div class="example-box">
                <h5>Modern Async/Await Approach</h5>
                <div class="code-box">
                  <pre>const fs = require('fs').promises;
async function readFileAsync() {
  try {
    console.log('Reading file...');
    const data = await fs.readFile('large-file.txt', 'utf8');
    console.log('File content:', data);
    console.log('Done');
  } catch (err) {
    console.error('Error:', err);
  }
}
readFileAsync();
<span class="comment">// Clean, readable, still non-blocking!
// async/await is syntactic sugar over Promises</span>
</pre>
                </div>
              </div>
            </div>
            <div class="section">
              <h3 class="section-title">2.5 Worker Threads for CPU-Intensive Tasks</h3>
              <div class="definition-box">
                <p>
                  For CPU-intensive operations, Node.js provides <strong>Worker Threads</strong> to run JavaScript
                  in parallel without blocking the main event loop.
                </p>
              </div>
              <div class="example-box">
                <h5>Example: Using Worker Threads</h5>
                <div class="code-box">
                  <pre><span class="comment">// main.js</span>
const { Worker } = require('worker_threads');
function runWorker(workerData) {
  return new Promise((resolve, reject) => {
    const worker = new Worker('./worker.js', { workerData });
    worker.on('message', resolve);
    worker.on('error', reject);
    worker.on('exit', (code) => {
      if (code !== 0) {
        reject(new Error(`Worker stopped with exit code ${code}`));
      }
    });
  });
}
async function main() {
  console.log('Starting heavy computation...');
  const result = await runWorker({ num: 45 });
  console.log('Fibonacci result:', result);
}
main();
<span class="comment">// worker.js</span>
const { parentPort, workerData } = require('worker_threads');
function fibonacci(n) {
  if (n <= 1) return n;
  return fibonacci(n - 1) + fibonacci(n - 2);
}
const result = fibonacci(workerData.num);
parentPort.postMessage(result);
</pre>
                </div>
              </div>
              <div class="example-box">
                <h5>Example: Worker Pool Pattern</h5>
                <div class="code-box">
                  <pre>const { Worker } = require('worker_threads');
const os = require('os');
class WorkerPool {
  constructor(workerScript, poolSize = os.cpus().length) {
    this.workerScript = workerScript;
    this.poolSize = poolSize;
    this.workers = [];
    this.queue = [];
    this.initializeWorkers();
  }
  initializeWorkers() {
    for (let i = 0; i < this.poolSize; i++) {
      const worker = new Worker(this.workerScript);
      worker.on('message', (result) => this.handleResult(worker, result));
      worker.on('error', (err) => this.handleError(worker, err));
      this.workers.push({ worker, busy: false, task: null });
    }
  }
  async execute(data) {
    return new Promise((resolve, reject) => {
      const availableWorker = this.workers.find(w => !w.busy);
      if (availableWorker) {
        this.assignTask(availableWorker, { data, resolve, reject });
      } else {
        this.queue.push({ data, resolve, reject });
      }
    });
  }
  assignTask(workerObj, task) {
    workerObj.busy = true;
    workerObj.task = task;
    workerObj.worker.postMessage(task.data);
  }
  handleResult(worker, result) {
    const workerObj = this.workers.find(w => w.worker === worker);
    workerObj.task.resolve(result);
    workerObj.busy = false;
    workerObj.task = null;
    if (this.queue.length > 0) {
      const nextTask = this.queue.shift();
      this.assignTask(workerObj, nextTask);
    }
  }
  handleError(worker, err) {
    const workerObj = this.workers.find(w => w.worker === worker);
    if (workerObj.task) {
      workerObj.task.reject(err);
    }
    workerObj.busy = false;
    workerObj.task = null;
  }
  terminate() {
    this.workers.forEach(w => w.worker.terminate());
  }
}
<span class="comment">// Usage:</span>
const pool = new WorkerPool('./heavy-task-worker.js', 4);
async function processTasks() {
  const tasks = Array.from({ length: 20 }, (_, i) => i);
  const results = await Promise.all(
    tasks.map(task => pool.execute(task))
  );
  console.log('All tasks completed:', results);
  pool.terminate();
}
processTasks();
</pre>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div id="lesson3" class="lesson">
          <div class="lesson-header">
            <h2>Module 3: Modules & NPM</h2>
          </div>
          <div class="lesson-content">
            <div class="section">
              <h3 class="section-title">3.1 Global Objects</h3>
              <div class="definition-box">
                <p>
                  Node.js provides <strong>global objects</strong> available everywhere without importing.
                  Similar to <code>window</code> in browsers, but Node uses <code>global</code>.
                </p>
              </div>
              <table class="comparison-table">
                <thead>
                  <tr>
                    <th>Global Object</th>
                    <th>Purpose/Description</th>
                    <th>Example</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td><strong>global</strong></td>
                    <td>The global namespace object</td>
                    <td><code>global.myVar = 'test'</code></td>
                  </tr>
                  <tr>
                    <td><strong>__dirname</strong></td>
                    <td>Absolute path of current directory</td>
                    <td><code>/home/user/project/src</code></td>
                  </tr>
                  <tr>
                    <td><strong>__filename</strong></td>
                    <td>Absolute path of current file</td>
                    <td><code>/home/user/project/src/app.js</code></td>
                  </tr>
                  <tr>
                    <td><strong>process</strong></td>
                    <td>Info about Node.js process</td>
                    <td><code>process.env, process.argv</code></td>
                  </tr>
                  <tr>
                    <td><strong>console</strong></td>
                    <td>Console logging</td>
                    <td><code>console.log(), console.error()</code></td>
                  </tr>
                  <tr>
                    <td><strong>Buffer</strong></td>
                    <td>Handle binary data</td>
                    <td><code>Buffer.from('hello')</code></td>
                  </tr>
                  <tr>
                    <td><strong>setTimeout</strong></td>
                    <td>Execute after delay</td>
                    <td><code>setTimeout(fn, 1000)</code></td>
                  </tr>
                  <tr>
                    <td><strong>setInterval</strong></td>
                    <td>Execute repeatedly</td>
                    <td><code>setInterval(fn, 1000)</code></td>
                  </tr>
                  <tr>
                    <td><strong>setImmediate</strong></td>
                    <td>Execute after I/O events</td>
                    <td><code>setImmediate(fn)</code></td>
                  </tr>
                </tbody>
              </table>
              <div class="example-box">
                <h5>Example: Using Global Objects</h5>
                <div class="code-box">
                  <pre><span class="comment">// Current directory and file</span>
console.log('Directory:', __dirname);
console.log('File:', __filename);
<span class="comment">// Process information</span>
console.log('Node version:', process.version);
console.log('Platform:', process.platform);
console.log('PID:', process.pid);
<span class="comment">// Environment variables</span>
console.log('PORT:', process.env.PORT || 3000);
console.log('NODE_ENV:', process.env.NODE_ENV);
<span class="comment">// Command line arguments</span>
console.log('Arguments:', process.argv);
<span class="comment">// Run: node app.js arg1 arg2
// Output: ['node', '/path/to/app.js', 'arg1', 'arg2']</span>
<span class="comment">// Working directory</span>
console.log('Current directory:', process.cwd());
<span class="comment">// Memory usage</span>
console.log('Memory:', process.memoryUsage());
<span class="comment">// Exit process</span>
process.on('SIGINT', () => {
  console.log('Received SIGINT. Exiting...');
  process.exit(0);
});
</pre>
                </div>
              </div>
            </div>
            <div class="section">
              <h3 class="section-title">3.2 Module System</h3>
              <div class="subsection">
                <h4 class="subsection-title">Types of Modules</h4>
                <table class="comparison-table">
                  <thead>
                    <tr>
                      <th>Type</th>
                      <th>Description</th>
                      <th>Examples</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td><strong>Core Modules</strong></td>
                      <td>Built-in modules (no installation needed)</td>
                      <td>fs, http, path, os, crypto, events</td>
                    </tr>
                    <tr>
                      <td><strong>User-Defined</strong></td>
                      <td>Custom modules you create</td>
                      <td>./myModule.js, ../utils/helper.js</td>
                    </tr>
                    <tr>
                      <td><strong>Third-Party</strong></td>
                      <td>Installed via NPM</td>
                      <td>express, lodash, axios, mongoose</td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <div class="subsection">
                <h4 class="subsection-title">CommonJS Module System</h4>
                <div class="example-box">
                  <h5>Example: Exporting Modules</h5>
                  <div class="code-box">
                    <pre><span class="comment">// mathUtils.js - Method 1: module.exports object</span>
module.exports = {
  add: (a, b) => a + b,
  subtract: (a, b) => a - b,
  multiply: (a, b) => a * b,
  divide: (a, b) => a / b
};
<span class="comment">// calculator.js - Method 2: exports shortcuts</span>
exports.square = (x) => x * x;
exports.cube = (x) => x * x * x;
exports.PI = 3.14159;
<span class="comment">// user.js - Method 3: export class</span>
class User {
  constructor(name, email) {
    this.name = name;
    this.email = email;
  }
  greet() {
    return `Hello, I'm ${this.name}`;
  }
}
module.exports = User;
<span class="comment">// database.js - Method 4: export function</span>
function connectDB(url) {
  console.log(`Connecting to ${url}`);
  return { connected: true };
}
module.exports = connectDB;
<span class="comment">// config.js - Method 5: multiple named exports</span>
const port = 3000;
const dbUrl = 'mongodb://localhost:27017';
function getConfig() {
  return { port, dbUrl };
}
module.exports = {
  port,
  dbUrl,
  getConfig
};
</pre>
                  </div>
                </div>
                <div class="example-box">
                  <h5>Example: Importing Modules</h5>
                  <div class="code-box">
                    <pre><span class="comment">// Importing core modules</span>
const fs = require('fs');
const path = require('path');
const http = require('http');
<span class="comment">// Importing user-defined modules</span>
const math = require('./mathUtils');
console.log(math.add(5, 3)); // 8
const calc = require('./calculator');
console.log(calc.square(4)); // 16
console.log(calc.PI); // 3.14159
const User = require('./user');
const user = new User('Alice', 'alice@example.com');
console.log(user.greet()); // Hello, I'm Alice
const connectDB = require('./database');
connectDB('mongodb://localhost:27017');
<span class="comment">// Destructuring imports</span>
const { port, dbUrl, getConfig } = require('./config');
console.log(port); // 3000
<span class="comment">// Importing third-party modules</span>
const express = require('express');
const axios = require('axios');
const _ = require('lodash');
</pre>
                  </div>
                </div>
              </div>
              <div class="subsection">
                <h4 class="subsection-title">ES6 Modules (ESM)</h4>
                <div class="code-box">
                  <pre><span class="comment">// package.json - enable ES modules</span>
{
  "type": "module"
}
<span class="comment">// mathUtils.mjs - Named exports</span>
export const add = (a, b) => a + b;
export const subtract = (a, b) => a - b;
export function multiply(a, b) {
  return a * b;
}
<span class="comment">// user.mjs - Default export</span>
export default class User {
  constructor(name) {
    this.name = name;
  }
}
<span class="comment">// config.mjs - Mixed exports</span>
export const PORT = 3000;
export const DB_URL = 'mongodb://localhost';
export default {
  port: PORT,
  dbUrl: DB_URL
};
<span class="comment">// app.mjs - Importing</span>
import { add, subtract, multiply } from './mathUtils.mjs';
import User from './user.mjs';
import config, { PORT, DB_URL } from './config.mjs';
console.log(add(5, 3)); // 8
const user = new User('Bob');
console.log(PORT); // 3000
</pre>
                </div>
              </div>
            </div>
            <div class="section">
              <h3 class="section-title">3.3 NPM (Node Package Manager)</h3>
              <div class="definition-box">
                <p>
                  <strong>NPM</strong> is the world's largest software registry with over 2 million packages.
                  It's automatically installed with Node.js.
                </p>
              </div>
              <div class="node-command">
                <pre><span class="comment"># Initialize new project</span>
<span class="prompt">$</span> npm init
<span class="comment"># or skip questions:</span>
<span class="prompt">$</span> npm init -y
<span class="comment"># Install package</span>
<span class="prompt">$</span> npm install express
<span class="prompt">$</span> npm i express  <span class="comment"># shorthand</span>
<span class="comment"># Install as dev dependency</span>
<span class="prompt">$</span> npm install --save-dev nodemon
<span class="prompt">$</span> npm i -D nodemon  <span class="comment"># shorthand</span>
<span class="comment"># Install globally</span>
<span class="prompt">$</span> npm install -g typescript
<span class="comment"># Install specific version</span>
<span class="prompt">$</span> npm install express@4.18.2
<span class="comment"># Install multiple packages</span>
<span class="prompt">$</span> npm install express mongoose dotenv cors
<span class="comment"># Uninstall package</span>
<span class="prompt">$</span> npm uninstall express
<span class="comment"># Update packages</span>
<span class="prompt">$</span> npm update
<span class="prompt">$</span> npm update express  <span class="comment"># specific package</span>
<span class="comment"># List installed packages</span>
<span class="prompt">$</span> npm list
<span class="prompt">$</span> npm list --depth=0  <span class="comment"># top-level only</span>
<span class="comment"># Check outdated packages</span>
<span class="prompt">$</span> npm outdated
<span class="comment"># Audit for vulnerabilities</span>
<span class="prompt">$</span> npm audit
<span class="prompt">$</span> npm audit fix  <span class="comment"># auto-fix</span>
<span class="comment"># Run scripts</span>
<span class="prompt">$</span> npm start
<span class="prompt">$</span> npm test
<span class="prompt">$</span> npm run dev
</pre>
              </div>
              <div class="subsection">
                <h4 class="subsection-title">package.json Structure</h4>
                <div class="code-box">
                  <pre>{
  "name": "my-app",
  "version": "1.0.0",
  "description": "My awesome Node.js application",
  "main": "index.js",
  "scripts": {
    "start": "node index.js",
    "dev": "nodemon index.js",
    "test": "jest",
    "build": "webpack --mode production"
  },
  "keywords": ["nodejs", "express", "api"],
  "author": "abdelghany-77",
  "license": "MIT",
  "dependencies": {
    "express": "^4.18.2",
    "mongoose": "^7.5.0",
    "dotenv": "^16.3.1"
  },
  "devDependencies": {
    "nodemon": "^3.0.1",
    "jest": "^29.7.0"
  },
  "engines": {
    "node": ">=18.0.0",
    "npm": ">=9.0.0"
  }
}
</pre>
                </div>
              </div>
              <div class="subsection">
                <h4 class="subsection-title">Semantic Versioning (SemVer)</h4>
                <div class="content-box">
                  <p><strong>Format:</strong> MAJOR.MINOR.PATCH (e.g., 1.4.2)</p>
                  <ul>
                    <li><strong>MAJOR:</strong> Breaking changes (incompatible API changes)</li>
                    <li><strong>MINOR:</strong> New features (backward-compatible)</li>
                    <li><strong>PATCH:</strong> Bug fixes (backward-compatible)</li>
                  </ul>
                </div>
                <table class="comparison-table">
                  <thead>
                    <tr>
                      <th>Symbol</th>
                      <th>Meaning</th>
                      <th>Example</th>
                      <th>Allows</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td><strong>^</strong> (Caret)</td>
                      <td>Compatible with version</td>
                      <td><code>^1.2.3</code></td>
                      <td>1.2.3, 1.2.4, 1.3.0, 1.9.9<br>(not 2.0.0)</td>
                    </tr>
                    <tr>
                      <td><strong>~</strong> (Tilde)</td>
                      <td>Approximately equivalent</td>
                      <td><code>~1.2.3</code></td>
                      <td>1.2.3, 1.2.4, 1.2.9<br>(not 1.3.0)</td>
                    </tr>
                    <tr>
                      <td><strong>*</strong></td>
                      <td>Any version</td>
                      <td><code>*</code></td>
                      <td>Any version (not recommended)</td>
                    </tr>
                    <tr>
                      <td><strong>No symbol</strong></td>
                      <td>Exact version</td>
                      <td><code>1.2.3</code></td>
                      <td>Only 1.2.3 (pinned)</td>
                    </tr>
                    <tr>
                      <td><strong>>=</strong></td>
                      <td>Greater or equal</td>
                      <td><code>>=1.2.0</code></td>
                      <td>1.2.0 and above</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="section">
              <h3 class="section-title">3.4 Common Core Modules</h3>
              <div class="example-box">
                <h5>File System (fs)</h5>
                <div class="code-box">
                  <pre>const fs = require('fs');
const fsPromises = require('fs').promises;
<span class="comment">// Synchronous (blocking)</span>
const data = fs.readFileSync('file.txt', 'utf8');
console.log(data);
<span class="comment">// Asynchronous with callback</span>
fs.readFile('file.txt', 'utf8', (err, data) => {
  if (err) throw err;
  console.log(data);
});
<span class="comment">// Asynchronous with Promises</span>
fsPromises.readFile('file.txt', 'utf8')
  .then(data => console.log(data))
  .catch(err => console.error(err));
<span class="comment">// Async/Await</span>
async function readFileAsync() {
  try {
    const data = await fsPromises.readFile('file.txt', 'utf8');
    console.log(data);
  } catch (err) {
    console.error(err);
  }
}
<span class="comment">// Write file</span>
fs.writeFile('output.txt', 'Hello World', err => {
  if (err) throw err;
  console.log('File written!');
});
<span class="comment">// Append to file</span>
fs.appendFile('log.txt', 'New log entry\n', err => {
  if (err) throw err;
});
<span class="comment">// Delete file</span>
fs.unlink('temp.txt', err => {
  if (err) throw err;
  console.log('File deleted');
});
<span class="comment">// Check if file exists</span>
fs.access('file.txt', fs.constants.F_OK, err => {
  console.log(err ? 'File does not exist' : 'File exists');
});
<span class="comment">// Create directory</span>
fs.mkdir('newDir', { recursive: true }, err => {
  if (err) throw err;
});
<span class="comment">// Read directory</span>
fs.readdir('./', (err, files) => {
  if (err) throw err;
  console.log('Files:', files);
});
</pre>
                </div>
              </div>
              <div class="example-box">
                <h5>Path Module</h5>
                <div class="code-box">
                  <pre>const path = require('path');
<span class="comment">// Join paths</span>
const filePath = path.join(__dirname, 'files', 'data.txt');
console.log(filePath); // /home/user/project/files/data.txt
<span class="comment">// Resolve absolute path</span>
const absolute = path.resolve('files', 'data.txt');
console.log(absolute);
<span class="comment">// Get directory name</span>
console.log(path.dirname('/home/user/file.txt')); // /home/user
<span class="comment">// Get file name</span>
console.log(path.basename('/home/user/file.txt')); // file.txt
console.log(path.basename('/home/user/file.txt', '.txt')); // file
<span class="comment">// Get extension</span>
console.log(path.extname('file.txt')); // .txt
<span class="comment">// Parse path</span>
const parsed = path.parse('/home/user/file.txt');
console.log(parsed);
// {
//   root: '/',
//   dir: '/home/user',
//   base: 'file.txt',
//   ext: '.txt',
//   name: 'file'
// }
<span class="comment">// Format path</span>
const formatted = path.format({
  dir: '/home/user',
  base: 'file.txt'
});
console.log(formatted); // /home/user/file.txt
<span class="comment">// Normalize path</span>
console.log(path.normalize('/home/user//files/../data.txt'));
// /home/user/data.txt
</pre>
                </div>
              </div>
              <div class="example-box">
                <h5>OS Module</h5>
                <div class="code-box">
                  <pre>const os = require('os');
<span class="comment">// Platform information</span>
console.log('Platform:', os.platform()); // linux, darwin, win32
console.log('Architecture:', os.arch()); // x64, arm, etc.
console.log('CPUs:', os.cpus().length);
console.log('Total Memory:', os.totalmem() / 1024 / 1024 / 1024, 'GB');
console.log('Free Memory:', os.freemem() / 1024 / 1024 / 1024, 'GB');
<span class="comment">// User information</span>
console.log('Home Directory:', os.homedir());
console.log('Username:', os.userInfo().username);
<span class="comment">// Network interfaces</span>
console.log('Network Interfaces:', os.networkInterfaces());
<span class="comment">// System uptime</span>
console.log('Uptime:', os.uptime(), 'seconds');
</pre>
                </div>
              </div>
              <div class="example-box">
                <h5>Events Module</h5>
                <div class="code-box">
                  <pre>const EventEmitter = require('events');
class MyEmitter extends EventEmitter {}
const myEmitter = new MyEmitter();
<span class="comment">// Register event listener</span>
myEmitter.on('event', (data) => {
  console.log('Event triggered:', data);
});
<span class="comment">// Emit event</span>
myEmitter.emit('event', { message: 'Hello!' });
<span class="comment">// One-time listener</span>
myEmitter.once('oneTime', () => {
  console.log('This will only fire once');
});
myEmitter.emit('oneTime');
myEmitter.emit('oneTime'); // Won't fire again
<span class="comment">// Remove listener</span>
const callback = () => console.log('Callback');
myEmitter.on('remove', callback);
myEmitter.removeListener('remove', callback);
<span class="comment">// Custom EventEmitter class</span>
class Logger extends EventEmitter {
  log(message) {
    console.log(message);
    this.emit('logged', { message, timestamp: Date.now() });
  }
}
const logger = new Logger();
logger.on('logged', (data) => {
  console.log('Log event:', data);
});
logger.log('Application started');
</pre>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div id="lesson4" class="lesson">
          <div class="lesson-header">
            <h2>Module 4: Web Concepts</h2>
          </div>
          <div class="lesson-content">
            <div class="section">
              <h3 class="section-title">4.1 Client-Server Model</h3>
              <div class="definition-box">
                <p>
                  The <strong>Client-Server Model</strong> is the fundamental architecture for web applications.
                  Clients request resources, and servers provide them.
                </p>
              </div>
              <div class="code-box">
                <pre>
<strong>Client-Server Communication Flow:</strong>
+-------------+                                 +-------------+
�   CLIENT    �                                 �   SERVER    �
�  (Browser,  �                                 �  (Node.js)  �
�  Mobile App)�                                 �             �
+-------------+                                 +-------------+
       �                                                �
       � 1. HTTP Request                                �
       �    GET /api/users                              �
       �----------------------------------------------->�
       �                                                �
       �                                      2. Process Request
       �                                      3. Query Database
       �                                      4. Prepare Response
       �                                                �
       � 5. HTTP Response                               �
       �    200 OK + JSON Data                          �
       �<-----------------------------------------------�
       �                                                �
       � 6. Render/Display Data                         �
       �                                                �
</pre>
              </div>
              <div class="highlight-box">
                <p><strong>Key Concepts:</strong></p>
                <ul>
                  <li><strong>Clients:</strong> Request resources (browsers, mobile apps, IoT devices)</li>
                  <li><strong>Servers:</strong> Store and process resources, respond to requests</li>
                  <li><strong>Stateless:</strong> Each request is independent (no memory of previous requests)</li>
                  <li><strong>Request-Response:</strong> Clients initiate, servers respond</li>
                </ul>
              </div>
            </div>
            <div class="section">
              <h3 class="section-title">4.2 HTTP Protocol</h3>
              <div class="definition-box">
                <p>
                  <strong>HTTP (Hypertext Transfer Protocol)</strong> is the foundation of data communication
                  on the web. It defines how messages are formatted and transmitted.
                </p>
              </div>
              <div class="subsection">
                <h4 class="subsection-title">HTTP Methods</h4>
                <table class="comparison-table">
                  <thead>
                    <tr>
                      <th>Method</th>
                      <th>Action</th>
                      <th>Idempotent</th>
                      <th>Use Case</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td><strong>GET</strong></td>
                      <td>Retrieve data from server</td>
                      <td><i class="fas fa-check"></i> Yes</td>
                      <td>Fetch user profile, list products</td>
                    </tr>
                    <tr>
                      <td><strong>POST</strong></td>
                      <td>Send data to server (create resource)</td>
                      <td><i class="fas fa-times"></i> No</td>
                      <td>Create new user, submit form</td>
                    </tr>
                    <tr>
                      <td><strong>PUT</strong></td>
                      <td>Replace existing resource</td>
                      <td><i class="fas fa-check"></i> Yes</td>
                      <td>Update entire user profile</td>
                    </tr>
                    <tr>
                      <td><strong>PATCH</strong></td>
                      <td>Partially modify resource</td>
                      <td><i class="fas fa-times"></i> No</td>
                      <td>Update user email only</td>
                    </tr>
                    <tr>
                      <td><strong>DELETE</strong></td>
                      <td>Remove resource from server</td>
                      <td><i class="fas fa-check"></i> Yes</td>
                      <td>Delete user account, remove item</td>
                    </tr>
                    <tr>
                      <td><strong>HEAD</strong></td>
                      <td>Get headers only (no body)</td>
                      <td><i class="fas fa-check"></i> Yes</td>
                      <td>Check if resource exists</td>
                    </tr>
                    <tr>
                      <td><strong>OPTIONS</strong></td>
                      <td>Check available methods</td>
                      <td><i class="fas fa-check"></i> Yes</td>
                      <td>CORS preflight requests</td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <div class="subsection">
                <h4 class="subsection-title">HTTP Status Codes</h4>
                <table class="comparison-table">
                  <thead>
                    <tr>
                      <th>Code</th>
                      <th>Category</th>
                      <th>Meaning</th>
                      <th>Examples</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td><strong>1xx</strong></td>
                      <td>Informational</td>
                      <td>Request received, processing</td>
                      <td>100 Continue, 101 Switching Protocols</td>
                    </tr>
                    <tr>
                      <td><strong>2xx</strong></td>
                      <td>Success</td>
                      <td>Request successful</td>
                      <td>200 OK, 201 Created, 204 No Content</td>
                    </tr>
                    <tr>
                      <td><strong>3xx</strong></td>
                      <td>Redirection</td>
                      <td>Further action needed</td>
                      <td>301 Moved Permanently, 302 Found, 304 Not Modified</td>
                    </tr>
                    <tr>
                      <td><strong>4xx</strong></td>
                      <td>Client Error</td>
                      <td>Client-side problem</td>
                      <td>400 Bad Request, 401 Unauthorized, 403 Forbidden, 404 Not Found</td>
                    </tr>
                    <tr>
                      <td><strong>5xx</strong></td>
                      <td>Server Error</td>
                      <td>Server-side problem</td>
                      <td>500 Internal Server Error, 502 Bad Gateway, 503 Service Unavailable</td>
                    </tr>
                  </tbody>
                </table>
                <div class="example-box">
                  <h5>Common Status Codes Explained</h5>
                  <div class="content-box">
                    <ul>
                      <li><strong>200 OK:</strong> Request successful, data returned</li>
                      <li><strong>201 Created:</strong> New resource created successfully</li>
                      <li><strong>204 No Content:</strong> Success, but no data to return (e.g., DELETE)</li>
                      <li><strong>400 Bad Request:</strong> Invalid request format/data</li>
                      <li><strong>401 Unauthorized:</strong> Authentication required or failed</li>
                      <li><strong>403 Forbidden:</strong> Authenticated but not authorized</li>
                      <li><strong>404 Not Found:</strong> Resource doesn't exist</li>
                      <li><strong>409 Conflict:</strong> Request conflicts with current state (e.g., duplicate email)
                      </li>
                      <li><strong>422 Unprocessable Entity:</strong> Valid request but semantic errors (validation
                        failed)</li>
                      <li><strong>500 Internal Server Error:</strong> Server encountered an error</li>
                      <li><strong>503 Service Unavailable:</strong> Server temporarily unavailable</li>
                    </ul>
                  </div>
                </div>
              </div>
              <div class="subsection">
                <h4 class="subsection-title">HTTP Headers</h4>
                <table class="comparison-table">
                  <thead>
                    <tr>
                      <th>Header Type</th>
                      <th>Examples</th>
                      <th>Purpose</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td><strong>Request Headers</strong></td>
                      <td>
                        <code>Accept</code><br>
                        <code>Authorization</code><br>
                        <code>Content-Type</code><br>
                        <code>User-Agent</code>
                      </td>
                      <td>
                        Acceptable response types<br>
                        Authentication credentials<br>
                        Request body format<br>
                        Client information
                      </td>
                    </tr>
                    <tr>
                      <td><strong>Response Headers</strong></td>
                      <td>
                        <code>Content-Type</code><br>
                        <code>Cache-Control</code><br>
                        <code>Set-Cookie</code><br>
                        <code>Location</code>
                      </td>
                      <td>
                        Response body format<br>
                        Caching directives<br>
                        Set cookies<br>
                        Redirect URL
                      </td>
                    </tr>
                    <tr>
                      <td><strong>CORS Headers</strong></td>
                      <td>
                        <code>Access-Control-Allow-Origin</code><br>
                        <code>Access-Control-Allow-Methods</code><br>
                        <code>Access-Control-Allow-Headers</code>
                      </td>
                      <td>
                        Allowed origins<br>
                        Allowed HTTP methods<br>
                        Allowed headers
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <div class="example-box">
                <h5>Example: HTTP Request and Response</h5>
                <div class="code-box">
                  <pre><span class="comment">// HTTP Request Example</span>
POST /api/users HTTP/1.1
Host: api.example.com
Content-Type: application/json
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Accept: application/json
User-Agent: Mozilla/5.0
{
  "name": "Alice Johnson",
  "email": "alice@example.com",
  "password": "securePassword123"
}
<span class="comment">// HTTP Response Example</span>
HTTP/1.1 201 Created
Content-Type: application/json
Location: /api/users/12345
Set-Cookie: sessionId=abc123; HttpOnly; Secure
X-RateLimit-Remaining: 99
{
  "id": "12345",
  "name": "Alice Johnson",
  "email": "alice@example.com",
  "createdAt": "2025-10-18T20:35:48Z"
}
</pre>
                </div>
              </div>
            </div>
            <div class="section">
              <h3 class="section-title">4.3 RESTful API Design</h3>
              <div class="definition-box">
                <p>
                  <strong>REST (Representational State Transfer)</strong> is an architectural style for
                  designing networked applications. It uses HTTP methods to perform CRUD operations.
                </p>
              </div>
              <div class="highlight-box">
                <p><strong>REST Principles:</strong></p>
                <ul>
                  <li><i class="fas fa-link"></i> <strong>Resource-Based:</strong> Everything is a resource (users, products, orders)</li>
                  <li><i class="fas fa-globe"></i> <strong>Stateless:</strong> Each request contains all information needed</li>
                  <li><i class="fas fa-random"></i> <strong>Cacheable:</strong> Responses can be cached for performance</li>
                  <li><i class="fas fa-box"></i> <strong>Uniform Interface:</strong> Consistent way to interact with resources</li>
                  <li><i class="fas fa-building"></i> <strong>Layered System:</strong> Client doesn't know if connected directly to server</li>
                </ul>
              </div>
              <div class="example-box">
                <h5>RESTful API Endpoints Design</h5>
                <table class="comparison-table">
                  <thead>
                    <tr>
                      <th>Method</th>
                      <th>Endpoint</th>
                      <th>Description</th>
                      <th>Request Body</th>
                      <th>Response</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td><strong>GET</strong></td>
                      <td><code>/api/users</code></td>
                      <td>Get all users</td>
                      <td>None</td>
                      <td>200 + Array of users</td>
                    </tr>
                    <tr>
                      <td><strong>GET</strong></td>
                      <td><code>/api/users/:id</code></td>
                      <td>Get user by ID</td>
                      <td>None</td>
                      <td>200 + User object</td>
                    </tr>
                    <tr>
                      <td><strong>POST</strong></td>
                      <td><code>/api/users</code></td>
                      <td>Create new user</td>
                      <td>User data (JSON)</td>
                      <td>201 + Created user</td>
                    </tr>
                    <tr>
                      <td><strong>PUT</strong></td>
                      <td><code>/api/users/:id</code></td>
                      <td>Update entire user</td>
                      <td>Complete user data</td>
                      <td>200 + Updated user</td>
                    </tr>
                    <tr>
                      <td><strong>PATCH</strong></td>
                      <td><code>/api/users/:id</code></td>
                      <td>Partially update user</td>
                      <td>Fields to update</td>
                      <td>200 + Updated user</td>
                    </tr>
                    <tr>
                      <td><strong>DELETE</strong></td>
                      <td><code>/api/users/:id</code></td>
                      <td>Delete user</td>
                      <td>None</td>
                      <td>204 No Content</td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <div class="example-box">
                <h5>Nested Resources</h5>
                <div class="code-box">
                  <pre><span class="comment">// User's posts (nested resource)</span>
GET    /api/users/:userId/posts          <span class="comment">// Get all posts by user</span>
GET    /api/users/:userId/posts/:postId  <span class="comment">// Get specific post by user</span>
POST   /api/users/:userId/posts          <span class="comment">// Create post for user</span>
PUT    /api/users/:userId/posts/:postId  <span class="comment">// Update user's post</span>
DELETE /api/users/:userId/posts/:postId  <span class="comment">// Delete user's post</span>
<span class="comment">// Post comments (deeply nested)</span>
GET    /api/posts/:postId/comments       <span class="comment">// Get all comments on post</span>
POST   /api/posts/:postId/comments       <span class="comment">// Add comment to post</span>
<span class="comment">// Query parameters for filtering, sorting, pagination</span>
GET /api/users?role=admin&sort=createdAt&limit=20&page=2
GET /api/products?category=electronics&minPrice=100&maxPrice=500
</pre>
                </div>
              </div>
              <div class="example-box">
                <h5>API Response Format Best Practices</h5>
                <div class="code-box">
                  <pre><span class="comment">// Success Response</span>
{
  "success": true,
  "data": {
    "id": "12345",
    "name": "Alice Johnson",
    "email": "alice@example.com"
  },
  "message": "User retrieved successfully"
}
<span class="comment">// Success with Pagination</span>
{
  "success": true,
  "data": [...],
  "pagination": {
    "page": 2,
    "limit": 20,
    "total": 150,
    "totalPages": 8
  }
}
<span class="comment">// Error Response</span>
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Invalid email format",
    "details": [
      {
        "field": "email",
        "message": "Must be a valid email address"
      }
    ]
  }
}
<span class="comment">// Multiple Errors</span>
{
  "success": false,
  "errors": [
    {
      "field": "email",
      "message": "Email is required"
    },
    {
      "field": "password",
      "message": "Password must be at least 8 characters"
    }
  ]
}
</pre>
                </div>
              </div>
            </div>
            <div class="section">
              <h3 class="section-title">4.4 URL Structure</h3>
              <div class="code-box">
                <pre>
<strong>URL Components:</strong>
https://api.example.com:443/api/v1/users/123?sort=name&limit=10#section
�      �   �               � �  �  �       � �                 � �
�      �   �               � �  �  �       � �                 � +- Fragment
�      �   �               � �  �  �       � +--------------------- Query String
�      �   �               � �  �  �       +--------------------- Resource ID
�      �   �               � �  �  +----------------------------- Resource
�      �   �               � �  +-------------------------------- API Version
�      �   �               � +----------------------------------- Base Path
�      �   �               +------------------------------------- Port
�      �   +----------------------------------------------------- Domain/Host
�      +--------------------------------------------------------- Protocol/Scheme
+---------------------------------------------------------------- Full URL
<strong>Parts Explained:</strong>
- Protocol: https (secure) or http
- Domain: api.example.com
- Port: 443 (default for HTTPS), 80 (default for HTTP)
- Path: /api/v1/users/123
- Query String: ?sort=name&limit=10
- Fragment: #section (used on client-side, not sent to server)
</pre>
              </div>
            </div>
          </div>
        </div>
        <div id="lesson5" class="lesson">
          <div class="lesson-header">
            <h2>Module 5: Security Concepts</h2>
          </div>
          <div class="lesson-content">
            <div class="section">
              <h3 class="section-title">5.1 Encryption vs Hashing</h3>
              <table class="comparison-table">
                <thead>
                  <tr>
                    <th>Feature</th>
                    <th>Encryption</th>
                    <th>Hashing</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td><strong>Direction</strong></td>
                    <td>Two-way (encrypt ? decrypt)</td>
                    <td>One-way only (irreversible)</td>
                  </tr>
                  <tr>
                    <td><strong>Purpose</strong></td>
                    <td>Protect data confidentiality</td>
                    <td>Verify data integrity</td>
                  </tr>
                  <tr>
                    <td><strong>Output</strong></td>
                    <td>Ciphertext (reversible)</td>
                    <td>Hash digest (fixed length, irreversible)</td>
                  </tr>
                  <tr>
                    <td><strong>Key Required</strong></td>
                    <td>Yes (encryption and decryption keys)</td>
                    <td>No (algorithm only)</td>
                  </tr>
                  <tr>
                    <td><strong>Same Input</strong></td>
                    <td>Different output each time (with different keys/IVs)</td>
                    <td>Always same output for same input</td>
                  </tr>
                  <tr>
                    <td><strong>Use Cases</strong></td>
                    <td>HTTPS, file encryption, secure messaging</td>
                    <td>Passwords, file checksums, digital signatures</td>
                  </tr>
                  <tr>
                    <td><strong>Algorithms</strong></td>
                    <td>AES, RSA, DES, 3DES</td>
                    <td>SHA-256, bcrypt, MD5 (insecure), SHA-1 (insecure)</td>
                  </tr>
                </tbody>
              </table>
              <div class="example-box">
                <h5>Example: Encryption (Symmetric)</h5>
                <div class="code-box">
                  <pre>const crypto = require('crypto');
<span class="comment">// Encryption configuration</span>
const algorithm = 'aes-256-cbc';
const key = crypto.randomBytes(32); // 256 bits
const iv = crypto.randomBytes(16);  // Initialization vector
<span class="comment">// Encrypt function</span>
function encrypt(text) {
  const cipher = crypto.createCipheriv(algorithm, key, iv);
  let encrypted = cipher.update(text, 'utf8', 'hex');
  encrypted += cipher.final('hex');
  return {
    iv: iv.toString('hex'),
    encryptedData: encrypted
  };
}
<span class="comment">// Decrypt function</span>
function decrypt(encryptedData, ivHex) {
  const decipher = crypto.createDecipheriv(
    algorithm,
    key,
    Buffer.from(ivHex, 'hex')
  );
  let decrypted = decipher.update(encryptedData, 'hex', 'utf8');
  decrypted += decipher.final('utf8');
  return decrypted;
}
<span class="comment">// Usage</span>
const text = 'Sensitive data';
const encrypted = encrypt(text);
console.log('Encrypted:', encrypted.encryptedData);
const decrypted = decrypt(encrypted.encryptedData, encrypted.iv);
console.log('Decrypted:', decrypted); // 'Sensitive data'
</pre>
                </div>
              </div>
              <div class="example-box">
                <h5>Example: Hashing (Password)</h5>
                <div class="code-box">
                  <pre>const bcrypt = require('bcrypt');
<span class="comment">// Hash password (with salt)</span>
async function hashPassword(password) {
  const saltRounds = 10; // Higher = more secure but slower
  const hashedPassword = await bcrypt.hash(password, saltRounds);
  return hashedPassword;
}
<span class="comment">// Verify password</span>
async function verifyPassword(password, hashedPassword) {
  const isMatch = await bcrypt.compare(password, hashedPassword);
  return isMatch;
}
<span class="comment">// Usage</span>
(async () => {
  const password = 'mySecurePassword123';
  <span class="comment">// Hash password before storing in database</span>
  const hashed = await hashPassword(password);
  console.log('Hashed:', hashed);
  // $2b$10$abc123... (always different even for same password)
  <span class="comment">// Verify during login</span>
  const isValid = await verifyPassword(password, hashed);
  console.log('Valid:', isValid); // true
  const isInvalid = await verifyPassword('wrongPassword', hashed);
  console.log('Invalid:', isInvalid); // false
})();
<span class="comment">// Why bcrypt?
// 1. Built-in salt (prevents rainbow table attacks)
// 2. Slow by design (prevents brute force)
// 3. Adaptive (can increase rounds as hardware improves)</span>
</pre>
                </div>
              </div>
              <div class="warning-box">
                <strong>Common Mistakes:</strong>
                <ul>
                  <li><i class="fas fa-times"></i> Using MD5 or SHA-1 for passwords (too fast, vulnerable)</li>
                  <li><i class="fas fa-times"></i> Encrypting passwords instead of hashing</li>
                  <li><i class="fas fa-times"></i> Not using salt with hashing</li>
                  <li><i class="fas fa-times"></i> Storing encryption keys in code</li>
                  <li><i class="fas fa-check"></i> Use bcrypt or argon2 for passwords</li>
                  <li><i class="fas fa-check"></i> Use environment variables for keys</li>
                  <li><i class="fas fa-check"></i> Use HTTPS for data in transit</li>
                </ul>
              </div>
            </div>
            <div class="section">
              <h3 class="section-title">5.2 Authentication vs Authorization</h3>
              <table class="comparison-table">
                <thead>
                  <tr>
                    <th>Aspect</th>
                    <th>Authentication</th>
                    <th>Authorization</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td><strong>Question</strong></td>
                    <td>"Who are you?"</td>
                    <td>"What can you do?"</td>
                  </tr>
                  <tr>
                    <td><strong>Purpose</strong></td>
                    <td>Verify identity</td>
                    <td>Verify permissions</td>
                  </tr>
                  <tr>
                    <td><strong>When</strong></td>
                    <td>First step (login)</td>
                    <td>After authentication</td>
                  </tr>
                  <tr>
                    <td><strong>Methods</strong></td>
                    <td>Password, biometrics, 2FA, OAuth</td>
                    <td>Roles, permissions, ACL, RBAC</td>
                  </tr>
                  <tr>
                    <td><strong>Example</strong></td>
                    <td>User logs in with email/password</td>
                    <td>Admin can delete users, regular user cannot</td>
                  </tr>
                  <tr>
                    <td><strong>Status Code</strong></td>
                    <td>401 Unauthorized (failed auth)</td>
                    <td>403 Forbidden (insufficient permissions)</td>
                  </tr>
                </tbody>
              </table>
              <div class="code-box">
                <pre>
<strong>Authentication & Authorization Flow:</strong>
+-------------+
�   Client    �
+-------------+
       �
       � 1. Login Request (email + password)
       �
       ?
+-----------------------------------------+
�           Authentication                �
�  - Verify credentials                   �
�  - Check if user exists                 �
�  - Compare password hash                �
+-----------------------------------------+
       �
       � 2. Generate Token (JWT)
       �
       ?
+-------------+
�   Client    � Stores token
+-------------+
       �
       � 3. Request with Token
       �    Authorization: Bearer <token>
       �
       ?
+-----------------------------------------+
�           Authorization                 �
�  - Verify token signature               �
�  - Extract user ID and roles            �
�  - Check if user has permission         �
�  - Allow or deny access                 �
+-----------------------------------------+
       �
       � 4. Response (200 OK or 403 Forbidden)
       �
       ?
+-------------+
�   Client    �
+-------------+
</pre>
              </div>
            </div>
            <div class="section">
              <h3 class="section-title">5.3 JWT (JSON Web Tokens)</h3>
              <div class="definition-box">
                <p>
                  <strong>JWT</strong> is a compact, URL-safe token format for securely transmitting information
                  between parties. Commonly used for authentication and information exchange.
                </p>
              </div>
              <div class="code-box">
                <pre>
<strong>JWT Structure:</strong>
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c
�                                     �                                                                                                �
�         HEADER                      �                          PAYLOAD                                                               �         SIGNATURE
�                                     �                                                                                                �
<strong>Header (Base64 encoded):</strong>
{
  "alg": "HS256",        // Algorithm
  "typ": "JWT"           // Type
}
<strong>Payload (Base64 encoded):</strong>
{
  "sub": "1234567890",   // Subject (user ID)
  "name": "John Doe",
  "iat": 1516239022,     // Issued at
  "exp": 1516325422      // Expiration
}
<strong>Signature:</strong>
HMACSHA256(
  base64UrlEncode(header) + "." + base64UrlEncode(payload),
  secret
)
</pre>
              </div>
              <div class="example-box">
                <h5>Example: Implementing JWT Authentication</h5>
                <div class="code-box">
                  <pre>const jwt = require('jsonwebtoken');
<span class="comment">// Secret key (store in environment variable!)</span>
const JWT_SECRET = process.env.JWT_SECRET || 'your-secret-key';
<span class="comment">// Generate JWT token</span>
function generateToken(user) {
  const payload = {
    id: user.id,
    email: user.email,
    role: user.role
  };
  const options = {
    expiresIn: '7d'  // Token expires in 7 days
  };
  return jwt.sign(payload, JWT_SECRET, options);
}
<span class="comment">// Verify JWT token</span>
function verifyToken(token) {
  try {
    const decoded = jwt.verify(token, JWT_SECRET);
    return { valid: true, decoded };
  } catch (error) {
    return { valid: false, error: error.message };
  }
}
<span class="comment">// Authentication middleware</span>
function authenticateToken(req, res, next) {
  const authHeader = req.headers['authorization'];
  const token = authHeader && authHeader.split(' ')[1]; // Bearer TOKEN
  if (!token) {
    return res.status(401).json({ error: 'Access token required' });
  }
  const result = verifyToken(token);
  if (!result.valid) {
    return res.status(403).json({ error: 'Invalid or expired token' });
  }
  req.user = result.decoded;
  next();
}
<span class="comment">// Authorization middleware (role-based)</span>
function authorize(...allowedRoles) {
  return (req, res, next) => {
    if (!req.user) {
      return res.status(401).json({ error: 'Not authenticated' });
    }
    if (!allowedRoles.includes(req.user.role)) {
      return res.status(403).json({ error: 'Insufficient permissions' });
    }
    next();
  };
}
<span class="comment">// Usage in routes</span>
app.post('/login', async (req, res) => {
  const { email, password } = req.body;
  <span class="comment">// Find user and verify password</span>
  const user = await User.findOne({ email });
  if (!user || !await bcrypt.compare(password, user.password)) {
    return res.status(401).json({ error: 'Invalid credentials' });
  }
  <span class="comment">// Generate token</span>
  const token = generateToken(user);
  res.json({
    success: true,
    token,
    user: {
      id: user.id,
      email: user.email,
      name: user.name
    }
  });
});
<span class="comment">// Protected route (authentication required)</span>
app.get('/profile', authenticateToken, (req, res) => {
  res.json({ user: req.user });
});
<span class="comment">// Admin-only route (authorization required)</span>
app.delete('/users/:id', authenticateToken, authorize('admin'), (req, res) => {
  // Only admin can access this
  res.json({ message: 'User deleted' });
});
<span class="comment">// Multiple roles allowed</span>
app.post('/posts', authenticateToken, authorize('admin', 'editor'), (req, res) => {
  // Admin or editor can create posts
  res.json({ message: 'Post created' });
});
</pre>
                </div>
              </div>
              <div class="example-box">
                <h5>Example: Refresh Token Pattern</h5>
                <div class="code-box">
                  <pre><span class="comment">// Generate access and refresh tokens</span>
function generateTokens(user) {
  const accessToken = jwt.sign(
    { id: user.id, email: user.email, role: user.role },
    process.env.JWT_ACCESS_SECRET,
    { expiresIn: '15m' }  // Short-lived
  );
  const refreshToken = jwt.sign(
    { id: user.id },
    process.env.JWT_REFRESH_SECRET,
    { expiresIn: '7d' }   // Long-lived
  );
  return { accessToken, refreshToken };
}
<span class="comment">// Login endpoint</span>
app.post('/login', async (req, res) => {
  const { email, password } = req.body;
  const user = await User.findOne({ email });
  if (!user || !await bcrypt.compare(password, user.password)) {
    return res.status(401).json({ error: 'Invalid credentials' });
  }
  const { accessToken, refreshToken } = generateTokens(user);
  <span class="comment">// Store refresh token in database</span>
  await RefreshToken.create({
    token: refreshToken,
    userId: user.id,
    expiresAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000)
  });
  res.json({
    success: true,
    accessToken,
    refreshToken
  });
});
<span class="comment">// Refresh token endpoint</span>
app.post('/refresh', async (req, res) => {
  const { refreshToken } = req.body;
  if (!refreshToken) {
    return res.status(401).json({ error: 'Refresh token required' });
  }
  try {
    <span class="comment">// Verify refresh token</span>
    const decoded = jwt.verify(refreshToken, process.env.JWT_REFRESH_SECRET);
    <span class="comment">// Check if refresh token exists in database</span>
    const storedToken = await RefreshToken.findOne({
      token: refreshToken,
      userId: decoded.id
    });
    if (!storedToken) {
      return res.status(403).json({ error: 'Invalid refresh token' });
    }
    <span class="comment">// Get user and generate new access token</span>
    const user = await User.findById(decoded.id);
    const accessToken = jwt.sign(
      { id: user.id, email: user.email, role: user.role },
      process.env.JWT_ACCESS_SECRET,
      { expiresIn: '15m' }
    );
    res.json({ accessToken });
  } catch (error) {
    res.status(403).json({ error: 'Invalid or expired refresh token' });
  }
});
<span class="comment">// Logout endpoint</span>
app.post('/logout', authenticateToken, async (req, res) => {
  const { refreshToken } = req.body;
  <span class="comment">// Remove refresh token from database</span>
  await RefreshToken.deleteOne({ token: refreshToken });
  res.json({ message: 'Logged out successfully' });
});
</pre>
                </div>
              </div>
            </div>
            <div class="section">
              <h3 class="section-title">5.4 Common Security Vulnerabilities</h3>
              <div class="component-grid">
                <div class="component-card">
                  <h4><i class="fas fa-star"></i> SQL Injection</h4>
                  <p style="text-align: left; font-size: 0.9em; margin-top: 10px;">
                    <strong>Risk:</strong> Malicious SQL queries<br>
                    <strong>Solution:</strong> Use parameterized queries, ORMs
                  </p>
                </div>
                <div class="component-card">
                  <h4><i class="fas fa-unlock"></i> XSS (Cross-Site Scripting)</h4>
                  <p style="text-align: left; font-size: 0.9em; margin-top: 10px;">
                    <strong>Risk:</strong> Inject malicious scripts<br>
                    <strong>Solution:</strong> Sanitize input, escape output
                  </p>
                </div>
                <div class="component-card">
                  <h4><i class="fas fa-random"></i> CSRF (Cross-Site Request Forgery)</h4>
                  <p style="text-align: left; font-size: 0.9em; margin-top: 10px;">
                    <strong>Risk:</strong> Unauthorized actions<br>
                    <strong>Solution:</strong> CSRF tokens, SameSite cookies
                  </p>
                </div>
                <div class="component-card">
                  <h4><i class="fas fa-key"></i> Broken Authentication</h4>
                  <p style="text-align: left; font-size: 0.9em; margin-top: 10px;">
                    <strong>Risk:</strong> Weak passwords, exposed sessions<br>
                    <strong>Solution:</strong> Strong passwords, 2FA, secure tokens
                  </p>
                </div>
                <div class="component-card">
                  <h4><i class="fas fa-star"></i> DDoS Attacks</h4>
                  <p style="text-align: left; font-size: 0.9em; margin-top: 10px;">
                    <strong>Risk:</strong> Service overload<br>
                    <strong>Solution:</strong> Rate limiting, load balancers
                  </p>
                </div>
                <div class="component-card">
                  <h4><i class="fas fa-box"></i> Insecure Dependencies</h4>
                  <p style="text-align: left; font-size: 0.9em; margin-top: 10px;">
                    <strong>Risk:</strong> Vulnerable packages<br>
                    <strong>Solution:</strong> npm audit, keep updated
                  </p>
                </div>
              </div>
              <div class="example-box">
                <h5>Security Best Practices</h5>
                <div class="code-box">
                  <pre>const helmet = require('helmet');
const rateLimit = require('express-rate-limit');
const mongoSanitize = require('express-mongo-sanitize');
const xss = require('xss-clean');
const hpp = require('hpp');
<span class="comment">// Set security HTTP headers</span>
app.use(helmet());
<span class="comment">// Rate limiting</span>
const limiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 minutes
  max: 100, // Limit each IP to 100 requests per windowMs
  message: 'Too many requests from this IP'
});
app.use('/api', limiter);
<span class="comment">// Data sanitization against NoSQL injection</span>
app.use(mongoSanitize());
<span class="comment">// Data sanitization against XSS</span>
app.use(xss());
<span class="comment">// Prevent HTTP Parameter Pollution</span>
app.use(hpp());
<span class="comment">// CORS configuration</span>
app.use(cors({
  origin: process.env.CLIENT_URL,
  credentials: true
}));
<span class="comment">// Input validation</span>
const { body, validationResult } = require('express-validator');
app.post('/register',
  body('email').isEmail().normalizeEmail(),
  body('password').isLength({ min: 8 }),
  (req, res) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({ errors: errors.array() });
    }
    // Process registration
  }
);
<span class="comment">// Environment variables for sensitive data</span>
require('dotenv').config();
const dbUrl = process.env.DATABASE_URL; // Never hardcode!
<span class="comment">// HTTPS only (in production)</span>
if (process.env.NODE_ENV === 'production') {
  app.use((req, res, next) => {
    if (req.header('x-forwarded-proto') !== 'https') {
      res.redirect(`https://${req.header('host')}${req.url}`);
    } else {
      next();
    }
  });
}
</pre>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div id="lesson6" class="lesson">
          <div class="lesson-header">
            <h2>Module 6: Express.js Framework</h2>
          </div>
          <div class="lesson-content">
            <div class="section">
              <h3 class="section-title">6.1 What is Express.js?</h3>
              <div class="definition-box">
                <p>
                  <strong>Express.js</strong> is a minimal and flexible Node.js web application framework that
                  provides a robust set of features for building web and mobile applications. It's the de facto
                  standard for Node.js web development.
                </p>
              </div>
              <div class="highlight-box">
                <p><strong>Key Features:</strong></p>
                <ul>
                  <li><i class="fas fa-rocket"></i> <strong>Fast & Minimalist:</strong> Lightweight with essential features</li>
                  <li><i class="fas fa-star"></i> <strong>Robust Routing:</strong> Powerful routing system</li>
                  <li><i class="fas fa-plug"></i> <strong>Middleware:</strong> Extensible through middleware functions</li>
                  <li><i class="fas fa-file"></i> <strong>Template Engines:</strong> Support for EJS, Pug, Handlebars</li>
                  <li><i class="fas fa-bullseye"></i> <strong>Focus on HTTP:</strong> Built-in methods for HTTP requests</li>
                  <li><i class="fas fa-building"></i> <strong>MVC Pattern:</strong> Supports Model-View-Controller architecture</li>
                </ul>
              </div>
              <div class="example-box">
                <h5>Example: Basic Express Server</h5>
                <div class="code-box">
                  <pre>const express = require('express');
const app = express();
<span class="comment">// Middleware for parsing JSON</span>
app.use(express.json());
app.use(express.urlencoded({ extended: true }));
<span class="comment">// Basic route</span>
app.get('/', (req, res) => {
  res.send('Hello Express!');
});
<span class="comment">// JSON response</span>
app.get('/api/data', (req, res) => {
  res.json({
    message: 'Success',
    data: { id: 1, name: 'Node.js' }
  });
});
<span class="comment">// Route with parameter</span>
app.get('/users/:id', (req, res) => {
  const userId = req.params.id;
  res.json({ userId, name: 'User ' + userId });
});
<span class="comment">// POST route</span>
app.post('/api/users', (req, res) => {
  const userData = req.body;
  res.status(201).json({
    message: 'User created',
    user: userData
  });
});
<span class="comment">// Start server</span>
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`Server running on port ${PORT}`);
});
</pre>
                </div>
              </div>
            </div>
            <div class="section">
              <h3 class="section-title">6.2 Routing</h3>
              <div class="subsection">
                <h4 class="subsection-title">Basic Routing</h4>
                <div class="code-box">
                  <pre>const express = require('express');
const app = express();
<span class="comment">// GET request</span>
app.get('/users', (req, res) => {
  res.json({ message: 'Get all users' });
});
<span class="comment">// POST request</span>
app.post('/users', (req, res) => {
  res.json({ message: 'Create user' });
});
<span class="comment">// PUT request</span>
app.put('/users/:id', (req, res) => {
  res.json({ message: `Update user ${req.params.id}` });
});
<span class="comment">// DELETE request</span>
app.delete('/users/:id', (req, res) => {
  res.json({ message: `Delete user ${req.params.id}` });
});
<span class="comment">// Handle all HTTP methods</span>
app.all('/secret', (req, res) => {
  res.send('Accessing secret section');
});
<span class="comment">// Route with multiple handlers</span>
app.get('/example', 
  (req, res, next) => {
    console.log('First handler');
    next(); // Pass to next handler
  },
  (req, res) => {
    res.send('Second handler');
  }
);
</pre>
                </div>
              </div>
              <div class="subsection">
                <h4 class="subsection-title">Route Parameters</h4>
                <div class="code-box">
                  <pre><span class="comment">// Single parameter</span>
app.get('/users/:id', (req, res) => {
  console.log(req.params.id);
  res.send(`User ID: ${req.params.id}`);
});
<span class="comment">// Multiple parameters</span>
app.get('/users/:userId/posts/:postId', (req, res) => {
  const { userId, postId } = req.params;
  res.json({ userId, postId });
});
<span class="comment">// Optional parameters (using regex)</span>
app.get('/users/:id?', (req, res) => {
  if (req.params.id) {
    res.send(`User ${req.params.id}`);
  } else {
    res.send('All users');
  }
});
<span class="comment">// Query parameters</span>
app.get('/search', (req, res) => {
  const { q, sort, limit } = req.query;
  // /search?q=node&sort=name&limit=10
  res.json({ query: q, sort, limit });
});
<span class="comment">// Route with regex</span>
app.get(/.*fly$/, (req, res) => {
  res.send('Match routes ending with fly');
  // Matches: butterfly, dragonfly, etc.
});
</pre>
                </div>
              </div>
              <div class="subsection">
                <h4 class="subsection-title">Router Module</h4>
                <div class="code-box">
                  <pre><span class="comment">// routes/users.js</span>
const express = require('express');
const router = express.Router();
<span class="comment">// Middleware specific to this router</span>
router.use((req, res, next) => {
  console.log('Time:', Date.now());
  next();
});
<span class="comment">// Define routes</span>
router.get('/', (req, res) => {
  res.json({ message: 'Get all users' });
});
router.get('/:id', (req, res) => {
  res.json({ message: `Get user ${req.params.id}` });
});
router.post('/', (req, res) => {
  res.json({ message: 'Create user', data: req.body });
});
router.put('/:id', (req, res) => {
  res.json({ message: `Update user ${req.params.id}`, data: req.body });
});
router.delete('/:id', (req, res) => {
  res.json({ message: `Delete user ${req.params.id}` });
});
module.exports = router;
<span class="comment">// app.js - Mount router</span>
const userRoutes = require('./routes/users');
app.use('/api/users', userRoutes);
<span class="comment">// Results in:
// GET    /api/users       - Get all users
// GET    /api/users/:id   - Get user by ID
// POST   /api/users       - Create user
// PUT    /api/users/:id   - Update user
// DELETE /api/users/:id   - Delete user</span>
</pre>
                </div>
              </div>
              <div class="example-box">
                <h5>Example: RESTful API Structure</h5>
                <div class="code-box">
                  <pre><span class="comment">// Project Structure
// project/
//   +-- app.js
//   +-- routes/
//   �   +-- users.js
//   �   +-- posts.js
//   �   +-- auth.js
//   +-- controllers/
//   �   +-- userController.js
//   �   +-- postController.js
//   �   +-- authController.js
//   +-- middleware/
//       +-- auth.js
//       +-- errorHandler.js</span>
<span class="comment">// controllers/userController.js</span>
exports.getAllUsers = async (req, res) => {
  try {
    const users = await User.find();
    res.json({
      success: true,
      count: users.length,
      data: users
    });
  } catch (error) {
    res.status(500).json({ success: false, error: error.message });
  }
};
exports.getUserById = async (req, res) => {
  try {
    const user = await User.findById(req.params.id);
    if (!user) {
      return res.status(404).json({ success: false, error: 'User not found' });
    }
    res.json({ success: true, data: user });
  } catch (error) {
    res.status(500).json({ success: false, error: error.message });
  }
};
exports.createUser = async (req, res) => {
  try {
    const user = await User.create(req.body);
    res.status(201).json({ success: true, data: user });
  } catch (error) {
    res.status(400).json({ success: false, error: error.message });
  }
};
exports.updateUser = async (req, res) => {
  try {
    const user = await User.findByIdAndUpdate(
      req.params.id,
      req.body,
      { new: true, runValidators: true }
    );
    if (!user) {
      return res.status(404).json({ success: false, error: 'User not found' });
    }
    res.json({ success: true, data: user });
  } catch (error) {
    res.status(400).json({ success: false, error: error.message });
  }
};
exports.deleteUser = async (req, res) => {
  try {
    const user = await User.findByIdAndDelete(req.params.id);
    if (!user) {
      return res.status(404).json({ success: false, error: 'User not found' });
    }
    res.json({ success: true, data: {} });
  } catch (error) {
    res.status(500).json({ success: false, error: error.message });
  }
};
<span class="comment">// routes/users.js</span>
const express = require('express');
const router = express.Router();
const {
  getAllUsers,
  getUserById,
  createUser,
  updateUser,
  deleteUser
} = require('../controllers/userController');
const { protect, authorize } = require('../middleware/auth');
router.route('/')
  .get(getAllUsers)
  .post(protect, authorize('admin'), createUser);
router.route('/:id')
  .get(getUserById)
  .put(protect, updateUser)
  .delete(protect, authorize('admin'), deleteUser);
module.exports = router;
<span class="comment">// app.js</span>
const express = require('express');
const userRoutes = require('./routes/users');
const postRoutes = require('./routes/posts');
const authRoutes = require('./routes/auth');
const app = express();
app.use(express.json());
app.use('/api/v1/users', userRoutes);
app.use('/api/v1/posts', postRoutes);
app.use('/api/v1/auth', authRoutes);
</pre>
                </div>
              </div>
            </div>
            <div class="section">
              <h3 class="section-title">6.3 Middleware</h3>
              <div class="definition-box">
                <p>
                  <strong>Middleware</strong> functions have access to the request object (req), response object (res),
                  and the next middleware function. They can execute code, modify req/res, end request-response cycle,
                  or call next middleware.
                </p>
              </div>
              <div class="code-box">
                <pre>
<strong>Middleware Execution Flow:</strong>
Request
   �
   ?
+-----------------+
�  Middleware 1   �  app.use(middleware1)
�  - Logging      �
+-----------------+
         � next()
         ?
+-----------------+
�  Middleware 2   �  app.use(middleware2)
�  - Auth Check   �
+-----------------+
         � next()
         ?
+-----------------+
�  Route Handler  �  app.get('/users', handler)
�  - Business     �
�    Logic        �
+-----------------+
         �
         ?
      Response
</pre>
              </div>
              <div class="example-box">
                <h5>Example: Custom Middleware</h5>
                <div class="code-box">
                  <pre><span class="comment">// Simple logging middleware</span>
const logger = (req, res, next) => {
  console.log(`${req.method} ${req.url} - ${new Date().toISOString()}`);
  next(); // Pass control to next middleware
};
app.use(logger);
<span class="comment">// Request timing middleware</span>
const requestTimer = (req, res, next) => {
  req.requestTime = Date.now();
  next();
};
app.use(requestTimer);
app.get('/time', (req, res) => {
  const elapsed = Date.now() - req.requestTime;
  res.json({ elapsed: `${elapsed}ms` });
});
<span class="comment">// Authentication middleware</span>
const isAuthenticated = (req, res, next) => {
  const token = req.headers.authorization;
  if (!token) {
    return res.status(401).json({ error: 'No token provided' });
  }
  try {
    const decoded = jwt.verify(token.split(' ')[1], process.env.JWT_SECRET);
    req.user = decoded;
    next();
  } catch (error) {
    return res.status(401).json({ error: 'Invalid token' });
  }
};
<span class="comment">// Role-based authorization middleware</span>
const hasRole = (...roles) => {
  return (req, res, next) => {
    if (!req.user) {
      return res.status(401).json({ error: 'Not authenticated' });
    }
    if (!roles.includes(req.user.role)) {
      return res.status(403).json({ error: 'Insufficient permissions' });
    }
    next();
  };
};
<span class="comment">// Usage</span>
app.get('/profile', isAuthenticated, (req, res) => {
  res.json({ user: req.user });
});
app.delete('/users/:id', isAuthenticated, hasRole('admin'), (req, res) => {
  // Only authenticated admins can access
  res.json({ message: 'User deleted' });
});
<span class="comment">// Error handling middleware (must be last)</span>
app.use((err, req, res, next) => {
  console.error(err.stack);
  res.status(err.status || 500).json({
    success: false,
    error: err.message || 'Internal Server Error'
  });
});
</pre>
                </div>
              </div>
              <div class="example-box">
                <h5>Popular Third-Party Middleware</h5>
                <div class="code-box">
                  <pre>const express = require('express');
const morgan = require('morgan');
const cors = require('cors');
const helmet = require('helmet');
const compression = require('compression');
const cookieParser = require('cookie-parser');
const app = express();
<span class="comment">// Body parsing middleware</span>
app.use(express.json());
app.use(express.urlencoded({ extended: true }));
<span class="comment">// Cookie parsing</span>
app.use(cookieParser());
<span class="comment">// HTTP request logger</span>
app.use(morgan('dev')); // 'dev', 'combined', 'common', 'short', 'tiny'
<span class="comment">// Security headers</span>
app.use(helmet());
<span class="comment">// Enable CORS</span>
app.use(cors({
  origin: process.env.CLIENT_URL,
  credentials: true
}));
<span class="comment">// Gzip compression</span>
app.use(compression());
<span class="comment">// Serve static files</span>
app.use(express.static('public'));
<span class="comment">// Rate limiting</span>
const rateLimit = require('express-rate-limit');
const limiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 minutes
  max: 100 // limit each IP to 100 requests per windowMs
});
app.use('/api', limiter);
<span class="comment">// File upload</span>
const multer = require('multer');
const upload = multer({ dest: 'uploads/' });
app.post('/upload', upload.single('file'), (req, res) => {
  res.json({ file: req.file });
});
</pre>
                </div>
              </div>
            </div>
            <div class="section">
              <h3 class="section-title">6.4 Request and Response Objects</h3>
              <div class="subsection">
                <h4 class="subsection-title">Request Object (req)</h4>
                <div class="code-box">
                  <pre>app.get('/example', (req, res) => {
  <span class="comment">// Route parameters</span>
  console.log(req.params);      // { id: '123' } from /users/:id
  <span class="comment">// Query parameters</span>
  console.log(req.query);       // { sort: 'name', limit: '10' } from ?sort=name&limit=10
  <span class="comment">// Request body</span>
  console.log(req.body);        // { name: 'John', email: 'john@example.com' }
  <span class="comment">// Headers</span>
  console.log(req.headers);     // All headers
  console.log(req.get('Content-Type')); // Specific header
  <span class="comment">// Cookies</span>
  console.log(req.cookies);     // Parsed cookies (needs cookie-parser)
  <span class="comment">// Request info</span>
  console.log(req.method);      // GET, POST, PUT, DELETE, etc.
  console.log(req.url);         // /example?sort=name
  console.log(req.path);        // /example
  console.log(req.protocol);    // http or https
  console.log(req.hostname);    // example.com
  console.log(req.ip);          // Client IP address
  <span class="comment">// Uploaded file (with multer)</span>
  console.log(req.file);        // Single file
  console.log(req.files);       // Multiple files
  <span class="comment">// Custom properties (added by middleware)</span>
  console.log(req.user);        // User data from auth middleware
  console.log(req.requestTime); // Added by custom middleware
});
</pre>
                </div>
              </div>
              <div class="subsection">
                <h4 class="subsection-title">Response Object (res)</h4>
                <div class="code-box">
                  <pre>app.get('/response-examples', (req, res) => {
  <span class="comment">// Send plain text</span>
  res.send('Hello World');
  <span class="comment">// Send JSON</span>
  res.json({ message: 'Success', data: { id: 1 } });
  <span class="comment">// Set status code and send</span>
  res.status(201).json({ message: 'Created' });
  <span class="comment">// Send status without body</span>
  res.sendStatus(404); // Not Found
  <span class="comment">// Redirect</span>
  res.redirect('/new-url');
  res.redirect(301, '/permanent-url');
  <span class="comment">// Set headers</span>
  res.set('Content-Type', 'application/json');
  res.set({
    'X-Custom-Header': 'value',
    'Content-Type': 'text/html'
  });
  <span class="comment">// Set cookies</span>
  res.cookie('token', 'abc123', {
    httpOnly: true,
    secure: true,
    maxAge: 3600000 // 1 hour
  });
  <span class="comment">// Clear cookie</span>
  res.clearCookie('token');
  <span class="comment">// Download file</span>
  res.download('/path/to/file.pdf');
  <span class="comment">// Send file</span>
  res.sendFile('/path/to/file.html');
  <span class="comment">// Render template (with template engine)</span>
  res.render('index', { title: 'Home', user: req.user });
  <span class="comment">// Stream response</span>
  const stream = fs.createReadStream('large-file.txt');
  stream.pipe(res);
  <span class="comment">// Set content type</span>
  res.type('json');    // application/json
  res.type('html');    // text/html
  res.type('txt');     // text/plain
  <span class="comment">// End response (no more writing)</span>
  res.end();
});
</pre>
                </div>
              </div>
            </div>
            <div class="section">
              <h3 class="section-title">6.5 Error Handling</h3>
              <div class="example-box">
                <h5>Example: Comprehensive Error Handling</h5>
                <div class="code-box">
                  <pre><span class="comment">// Custom Error Class</span>
class AppError extends Error {
  constructor(message, statusCode) {
    super(message);
    this.statusCode = statusCode;
    this.status = `${statusCode}`.startsWith('4') ? 'fail' : 'error';
    this.isOperational = true;
    Error.captureStackTrace(this, this.constructor);
  }
}
<span class="comment">// Async error handler wrapper</span>
const catchAsync = (fn) => {
  return (req, res, next) => {
    fn(req, res, next).catch(next);
  };
};
<span class="comment">// Usage in route handlers</span>
app.get('/users/:id', catchAsync(async (req, res, next) => {
  const user = await User.findById(req.params.id);
  if (!user) {
    return next(new AppError('User not found', 404));
  }
  res.json({ success: true, data: user });
}));
<span class="comment">// 404 handler (must be after all routes)</span>
app.all('*', (req, res, next) => {
  next(new AppError(`Can't find ${req.originalUrl}`, 404));
});
<span class="comment">// Global error handling middleware (must be last)</span>
app.use((err, req, res, next) => {
  err.statusCode = err.statusCode || 500;
  err.status = err.status || 'error';
  if (process.env.NODE_ENV === 'development') {
    // Development: send detailed error
    res.status(err.statusCode).json({
      status: err.status,
      error: err,
      message: err.message,
      stack: err.stack
    });
  } else {
    // Production: send user-friendly error
    if (err.isOperational) {
      // Operational, trusted error: send message to client
      res.status(err.statusCode).json({
        status: err.status,
        message: err.message
      });
    } else {
      // Programming or unknown error: don't leak details
      console.error('ERROR <i class="fas fa-star"></i>', err);
      res.status(500).json({
        status: 'error',
        message: 'Something went wrong!'
      });
    }
  }
});
<span class="comment">// Handle unhandled promise rejections</span>
process.on('unhandledRejection', (err) => {
  console.log('UNHANDLED REJECTION! <i class="fas fa-star"></i> Shutting down...');
  console.log(err.name, err.message);
  server.close(() => {
    process.exit(1);
  });
});
<span class="comment">// Handle uncaught exceptions</span>
process.on('uncaughtException', (err) => {
  console.log('UNCAUGHT EXCEPTION! <i class="fas fa-star"></i> Shutting down...');
  console.log(err.name, err.message);
  process.exit(1);
});
</pre>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div id="lesson7" class="lesson">
          <div class="lesson-header">
            <h2>Module 7: Working with Databases</h2>
          </div>
          <div class="lesson-content">
            <div class="section">
              <h3 class="section-title">7.1 MongoDB with Mongoose</h3>
              <div class="example-box">
                <h5>Example: MongoDB Connection and Setup</h5>
                <div class="code-box">
                  <pre>const mongoose = require('mongoose');
<span class="comment">// Connect to MongoDB</span>
const connectDB = async () => {
  try {
    const conn = await mongoose.connect(process.env.MONGO_URI, {
      useNewUrlParser: true,
      useUnifiedTopology: true
    });
    console.log(`MongoDB Connected: ${conn.connection.host}`);
  } catch (error) {
    console.error(`Error: ${error.message}`);
    process.exit(1);
  }
};
<span class="comment">// Define Schema</span>
const userSchema = new mongoose.Schema({
  name: {
    type: String,
    required: [true, 'Name is required'],
    trim: true,
    maxlength: [50, 'Name cannot exceed 50 characters']
  },
  email: {
    type: String,
    required: [true, 'Email is required'],
    unique: true,
    lowercase: true,
    match: [/^\S+@\S+\.\S+$/, 'Please provide valid email']
  },
  password: {
    type: String,
    required: [true, 'Password is required'],
    minlength: [8, 'Password must be at least 8 characters'],
    select: false // Don't include in queries by default
  },
  role: {
    type: String,
    enum: ['user', 'admin', 'moderator'],
    default: 'user'
  },
  avatar: String,
  isActive: {
    type: Boolean,
    default: true
  },
  lastLogin: Date
}, {
  timestamps: true // Adds createdAt and updatedAt
});
<span class="comment">// Pre-save middleware (hash password)</span>
userSchema.pre('save', async function(next) {
  if (!this.isModified('password')) return next();
  this.password = await bcrypt.hash(this.password, 10);
  next();
});
<span class="comment">// Instance method</span>
userSchema.methods.comparePassword = async function(candidatePassword) {
  return await bcrypt.compare(candidatePassword, this.password);
};
<span class="comment">// Static method</span>
userSchema.statics.findByEmail = function(email) {
  return this.findOne({ email });
};
<span class="comment">// Virtual property</span>
userSchema.virtual('fullInfo').get(function() {
  return `${this.name} (${this.email})`;
});
<span class="comment">// Create Model</span>
const User = mongoose.model('User', userSchema);
module.exports = User;
</pre>
                </div>
              </div>
              <div class="example-box">
                <h5>Example: CRUD Operations with Mongoose</h5>
                <div class="code-box">
                  <pre>const User = require('./models/User');
<span class="comment">// CREATE</span>
exports.createUser = async (req, res) => {
  try {
    const user = await User.create(req.body);
    res.status(201).json({ success: true, data: user });
  } catch (error) {
    res.status(400).json({ success: false, error: error.message });
  }
};
<span class="comment">// READ - Get all users</span>
exports.getUsers = async (req, res) => {
  try {
    <span class="comment">// Advanced filtering</span>
    const queryObj = { ...req.query };
    const excludedFields = ['page', 'sort', 'limit', 'fields'];
    excludedFields.forEach(field => delete queryObj[field]);
    <span class="comment">// Add operators ($gte, $gt, $lte, $lt)</span>
    let queryStr = JSON.stringify(queryObj);
    queryStr = queryStr.replace(/\b(gte|gt|lte|lt)\b/g, match => `$${match}`);
    let query = User.find(JSON.parse(queryStr));
    <span class="comment">// Sorting</span>
    if (req.query.sort) {
      const sortBy = req.query.sort.split(',').join(' ');
      query = query.sort(sortBy);
    } else {
      query = query.sort('-createdAt');
    }
    <span class="comment">// Field limiting</span>
    if (req.query.fields) {
      const fields = req.query.fields.split(',').join(' ');
      query = query.select(fields);
    }
    <span class="comment">// Pagination</span>
    const page = parseInt(req.query.page, 10) || 1;
    const limit = parseInt(req.query.limit, 10) || 10;
    const skip = (page - 1) * limit;
    query = query.skip(skip).limit(limit);
    const users = await query;
    const total = await User.countDocuments();
    res.json({
      success: true,
      count: users.length,
      pagination: {
        page,
        limit,
        total,
        pages: Math.ceil(total / limit)
      },
      data: users
    });
  } catch (error) {
    res.status(500).json({ success: false, error: error.message });
  }
};
<span class="comment">// READ - Get single user</span>
exports.getUser = async (req, res) => {
  try {
    const user = await User.findById(req.params.id);
    if (!user) {
      return res.status(404).json({ success: false, error: 'User not found' });
    }
    res.json({ success: true, data: user });
  } catch (error) {
    res.status(500).json({ success: false, error: error.message });
  }
};
<span class="comment">// UPDATE</span>
exports.updateUser = async (req, res) => {
  try {
    const user = await User.findByIdAndUpdate(
      req.params.id,
      req.body,
      {
        new: true,         // Return updated document
        runValidators: true // Run schema validators
      }
    );
    if (!user) {
      return res.status(404).json({ success: false, error: 'User not found' });
    }
    res.json({ success: true, data: user });
  } catch (error) {
    res.status(400).json({ success: false, error: error.message });
  }
};
<span class="comment">// DELETE</span>
exports.deleteUser = async (req, res) => {
  try {
    const user = await User.findByIdAndDelete(req.params.id);
    if (!user) {
      return res.status(404).json({ success: false, error: 'User not found' });
    }
    res.json({ success: true, data: {} });
  } catch (error) {
    res.status(500).json({ success: false, error: error.message });
  }
};
<span class="comment">// Complex queries</span>
exports.advancedQueries = async (req, res) => {
  <span class="comment">// Find users with specific criteria</span>
  const users = await User.find({
    role: 'admin',
    isActive: true,
    createdAt: { $gte: new Date('2024-01-01') }
  });
  <span class="comment">// Aggregation pipeline</span>
  const stats = await User.aggregate([
    { $match: { isActive: true } },
    { $group: {
        _id: '$role',
        count: { $sum: 1 },
        avgAge: { $avg: '$age' }
      }
    },
    { $sort: { count: -1 } }
  ]);
  <span class="comment">// Population (join-like)</span>
  const user = await User.findById(id).populate('posts');
  res.json({ users, stats });
};
</pre>
                </div>
              </div>
            </div>
            <div class="section">
              <h3 class="section-title">7.2 Relationships in MongoDB</h3>
              <div class="example-box">
                <h5>Example: One-to-Many Relationship</h5>
                <div class="code-box">
                  <pre><span class="comment">// User Schema</span>
const userSchema = new mongoose.Schema({
  name: String,
  email: String
});
const User = mongoose.model('User', userSchema);
<span class="comment">// Post Schema (references User)</span>
const postSchema = new mongoose.Schema({
  title: String,
  content: String,
  author: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'User',  // Reference to User model
    required: true
  },
  comments: [{
    text: String,
    user: {
      type: mongoose.Schema.Types.ObjectId,
      ref: 'User'
    },
    createdAt: {
      type: Date,
      default: Date.now
    }
  }]
}, {
  timestamps: true
});
const Post = mongoose.model('Post', postSchema);
<span class="comment">// Create post with reference</span>
const post = await Post.create({
  title: 'My First Post',
  content: 'Hello World',
  author: userId  // ObjectId of user
});
<span class="comment">// Populate (join) author data</span>
const postWithAuthor = await Post.findById(postId).populate('author');
// Now postWithAuthor.author contains full user object
<span class="comment">// Populate with field selection</span>
const post = await Post.findById(postId)
  .populate('author', 'name email')  // Only name and email
  .populate({
    path: 'comments.user',
    select: 'name avatar'
  });
<span class="comment">// Deep population</span>
const post = await Post.findById(postId)
  .populate({
    path: 'author',
    populate: {
      path: 'profile'
    }
  });
</pre>
                </div>
              </div>
            </div>
            <div class="section">
              <h3 class="section-title">7.3 SQL Database with PostgreSQL</h3>
              <div class="example-box">
                <h5>Example: PostgreSQL with pg Library</h5>
                <div class="code-box">
                  <pre>const { Pool } = require('pg');
<span class="comment">// Create connection pool</span>
const pool = new Pool({
  user: process.env.DB_USER,
  host: process.env.DB_HOST,
  database: process.env.DB_NAME,
  password: process.env.DB_PASSWORD,
  port: process.env.DB_PORT || 5432,
  max: 20, // Maximum number of clients
  idleTimeoutMillis: 30000,
  connectionTimeoutMillis: 2000,
});
<span class="comment">// Test connection</span>
pool.query('SELECT NOW()', (err, res) => {
  if (err) {
    console.error('Database connection error:', err);
  } else {
    console.log('Database connected:', res.rows[0].now);
  }
});
<span class="comment">// CREATE - Insert user</span>
exports.createUser = async (req, res) => {
  const { name, email, password } = req.body;
  try {
    const hashedPassword = await bcrypt.hash(password, 10);
    const result = await pool.query(
      'INSERT INTO users (name, email, password) VALUES ($1, $2, $3) RETURNING *',
      [name, email, hashedPassword]
    );
    res.status(201).json({
      success: true,
      data: result.rows[0]
    });
  } catch (error) {
    res.status(400).json({ success: false, error: error.message });
  }
};
<span class="comment">// READ - Get all users</span>
exports.getUsers = async (req, res) => {
  try {
    const { page = 1, limit = 10, sort = 'created_at', order = 'DESC' } = req.query;
    const offset = (page - 1) * limit;
    const result = await pool.query(
      `SELECT id, name, email, role, created_at 
       FROM users 
       WHERE is_active = true 
       ORDER BY ${sort} ${order} 
       LIMIT $1 OFFSET $2`,
      [limit, offset]
    );
    const countResult = await pool.query('SELECT COUNT(*) FROM users WHERE is_active = true');
    const total = parseInt(countResult.rows[0].count);
    res.json({
      success: true,
      count: result.rows.length,
      pagination: {
        page: parseInt(page),
        limit: parseInt(limit),
        total,
        pages: Math.ceil(total / limit)
      },
      data: result.rows
    });
  } catch (error) {
    res.status(500).json({ success: false, error: error.message });
  }
};
<span class="comment">// READ - Get single user</span>
exports.getUser = async (req, res) => {
  try {
    const result = await pool.query(
      'SELECT id, name, email, role, created_at FROM users WHERE id = $1',
      [req.params.id]
    );
    if (result.rows.length === 0) {
      return res.status(404).json({ success: false, error: 'User not found' });
    }
    res.json({ success: true, data: result.rows[0] });
  } catch (error) {
    res.status(500).json({ success: false, error: error.message });
  }
};
<span class="comment">// UPDATE</span>
exports.updateUser = async (req, res) => {
  const { name, email } = req.body;
  try {
    const result = await pool.query(
      'UPDATE users SET name = $1, email = $2, updated_at = NOW() WHERE id = $3 RETURNING *',
      [name, email, req.params.id]
    );
    if (result.rows.length === 0) {
      return res.status(404).json({ success: false, error: 'User not found' });
    }
    res.json({ success: true, data: result.rows[0] });
  } catch (error) {
    res.status(400).json({ success: false, error: error.message });
  }
};
<span class="comment">// DELETE</span>
exports.deleteUser = async (req, res) => {
  try {
    const result = await pool.query(
      'DELETE FROM users WHERE id = $1 RETURNING id',
      [req.params.id]
    );
    if (result.rows.length === 0) {
      return res.status(404).json({ success: false, error: 'User not found' });
    }
    res.json({ success: true, data: {} });
  } catch (error) {
    res.status(500).json({ success: false, error: error.message });
  }
};
<span class="comment">// Transaction example</span>
exports.transferFunds = async (req, res) => {
  const { fromAccount, toAccount, amount } = req.body;
  const client = await pool.connect();
  try {
    await client.query('BEGIN');
    <span class="comment">// Deduct from sender</span>
    await client.query(
      'UPDATE accounts SET balance = balance - $1 WHERE id = $2',
      [amount, fromAccount]
    );
    <span class="comment">// Add to receiver</span>
    await client.query(
      'UPDATE accounts SET balance = balance + $1 WHERE id = $2',
      [amount, toAccount]
    );
    await client.query('COMMIT');
    res.json({ success: true, message: 'Transfer successful' });
  } catch (error) {
    await client.query('ROLLBACK');
    res.status(400).json({ success: false, error: error.message });
  } finally {
    client.release();
  }
};
</pre>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div id="lesson8" class="lesson">
          <div class="lesson-header">
            <h2>Module 8: Authentication & Authorization</h2>
          </div>
          <div class="lesson-content">
            <div class="section">
              <h3 class="section-title">8.1 Complete Authentication System</h3>
              <div class="example-box">
                <h5>Example: Full Authentication Implementation</h5>
                <div class="code-box">
                  <pre><span class="comment">// models/User.js</span>
const mongoose = require('mongoose');
const bcrypt = require('bcryptjs');
const jwt = require('jsonwebtoken');
const crypto = require('crypto');
const userSchema = new mongoose.Schema({
  name: {
    type: String,
    required: [true, 'Please provide a name'],
    trim: true
  },
  email: {
    type: String,
    required: [true, 'Please provide an email'],
    unique: true,
    lowercase: true,
    match: [/^\S+@\S+\.\S+$/, 'Please provide valid email']
  },
  password: {
    type: String,
    required: [true, 'Please provide a password'],
    minlength: [8, 'Password must be at least 8 characters'],
    select: false
  },
  role: {
    type: String,
    enum: ['user', 'admin', 'moderator'],
    default: 'user'
  },
  avatar: String,
  isActive: {
    type: Boolean,
    default: true
  },
  emailVerified: {
    type: Boolean,
    default: false
  },
  emailVerificationToken: String,
  emailVerificationExpire: Date,
  resetPasswordToken: String,
  resetPasswordExpire: Date,
  passwordChangedAt: Date,
  loginAttempts: {
    type: Number,
    default: 0
  },
  lockUntil: Date
}, {
  timestamps: true
});
<span class="comment">// Encrypt password before saving</span>
userSchema.pre('save', async function(next) {
  if (!this.isModified('password')) return next();
  this.password = await bcrypt.hash(this.password, 12);
  this.passwordChangedAt = Date.now() - 1000;
  next();
});
<span class="comment">// Compare password</span>
userSchema.methods.comparePassword = async function(candidatePassword) {
  return await bcrypt.compare(candidatePassword, this.password);
};
<span class="comment">// Generate JWT token</span>
userSchema.methods.generateAuthToken = function() {
  return jwt.sign(
    { id: this._id, role: this.role },
    process.env.JWT_SECRET,
    { expiresIn: process.env.JWT_EXPIRE || '7d' }
  );
};
<span class="comment">// Generate refresh token</span>
userSchema.methods.generateRefreshToken = function() {
  return jwt.sign(
    { id: this._id },
    process.env.JWT_REFRESH_SECRET,
    { expiresIn: '30d' }
  );
};
<span class="comment">// Generate email verification token</span>
userSchema.methods.generateEmailVerificationToken = function() {
  const verificationToken = crypto.randomBytes(32).toString('hex');
  this.emailVerificationToken = crypto
    .createHash('sha256')
    .update(verificationToken)
    .digest('hex');
  this.emailVerificationExpire = Date.now() + 24 * 60 * 60 * 1000; // 24 hours
  return verificationToken;
};
<span class="comment">// Generate password reset token</span>
userSchema.methods.generateResetPasswordToken = function() {
  const resetToken = crypto.randomBytes(32).toString('hex');
  this.resetPasswordToken = crypto
    .createHash('sha256')
    .update(resetToken)
    .digest('hex');
  this.resetPasswordExpire = Date.now() + 10 * 60 * 1000; // 10 minutes
  return resetToken;
};
<span class="comment">// Check if password was changed after token was issued</span>
userSchema.methods.changedPasswordAfter = function(JWTTimestamp) {
  if (this.passwordChangedAt) {
    const changedTimestamp = parseInt(this.passwordChangedAt.getTime() / 1000, 10);
    return JWTTimestamp < changedTimestamp;
  }
  return false;
};
<span class="comment">// Virtual for account locked</span>
userSchema.virtual('isLocked').get(function() {
  return !!(this.lockUntil && this.lockUntil > Date.now());
});
<span class="comment">// Increment login attempts</span>
userSchema.methods.incLoginAttempts = function() {
  if (this.lockUntil && this.lockUntil < Date.now()) {
    return this.updateOne({
      $set: { loginAttempts: 1 },
      $unset: { lockUntil: 1 }
    });
  }
  const updates = { $inc: { loginAttempts: 1 } };
  const needsLock = this.loginAttempts + 1 >= 5;
  if (needsLock) {
    updates.$set = { lockUntil: Date.now() + 2 * 60 * 60 * 1000 }; // 2 hours
  }
  return this.updateOne(updates);
};
<span class="comment">// Reset login attempts</span>
userSchema.methods.resetLoginAttempts = function() {
  return this.updateOne({
    $set: { loginAttempts: 0 },
    $unset: { lockUntil: 1 }
  });
};
module.exports = mongoose.model('User', userSchema);
</pre>
                </div>
              </div>
              <div class="example-box">
                <h5>Example: Authentication Controller</h5>
                <div class="code-box">
                  <pre><span class="comment">// controllers/authController.js</span>
const User = require('../models/User');
const crypto = require('crypto');
const sendEmail = require('../utils/sendEmail');
<span class="comment">// Register user</span>
exports.register = async (req, res) => {
  try {
    const { name, email, password } = req.body;
    <span class="comment">// Check if user exists</span>
    let user = await User.findOne({ email });
    if (user) {
      return res.status(400).json({
        success: false,
        error: 'User already exists'
      });
    }
    <span class="comment">// Create user</span>
    user = await User.create({ name, email, password });
    <span class="comment">// Generate email verification token</span>
    const verificationToken = user.generateEmailVerificationToken();
    await user.save({ validateBeforeSave: false });
    <span class="comment">// Send verification email</span>
    const verificationUrl = `${req.protocol}://${req.get('host')}/api/auth/verify-email/${verificationToken}`;
    const message = `Please verify your email by clicking: ${verificationUrl}`;
    try {
      await sendEmail({
        email: user.email,
        subject: 'Email Verification',
        message
      });
    } catch (error) {
      user.emailVerificationToken = undefined;
      user.emailVerificationExpire = undefined;
      await user.save({ validateBeforeSave: false });
      return res.status(500).json({
        success: false,
        error: 'Email could not be sent'
      });
    }
    <span class="comment">// Generate tokens</span>
    const accessToken = user.generateAuthToken();
    const refreshToken = user.generateRefreshToken();
    res.status(201).json({
      success: true,
      message: 'User registered successfully. Please verify your email.',
      accessToken,
      refreshToken,
      user: {
        id: user._id,
        name: user.name,
        email: user.email,
        role: user.role
      }
    });
  } catch (error) {
    res.status(400).json({
      success: false,
      error: error.message
    });
  }
};
<span class="comment">// Login user</span>
exports.login = async (req, res) => {
  try {
    const { email, password } = req.body;
    <span class="comment">// Validate input</span>
    if (!email || !password) {
      return res.status(400).json({
        success: false,
        error: 'Please provide email and password'
      });
    }
    <span class="comment">// Find user and include password</span>
    const user = await User.findOne({ email }).select('+password');
    if (!user) {
      return res.status(401).json({
        success: false,
        error: 'Invalid credentials'
      });
    }
    <span class="comment">// Check if account is locked</span>
    if (user.isLocked) {
      return res.status(423).json({
        success: false,
        error: 'Account is locked due to too many failed login attempts. Try again later.'
      });
    }
    <span class="comment">// Check if account is active</span>
    if (!user.isActive) {
      return res.status(401).json({
        success: false,
        error: 'Your account has been deactivated'
      });
    }
    <span class="comment">// Verify password</span>
    const isPasswordValid = await user.comparePassword(password);
    if (!isPasswordValid) {
      await user.incLoginAttempts();
      return res.status(401).json({
        success: false,
        error: 'Invalid credentials'
      });
    }
    <span class="comment">// Reset login attempts on successful login</span>
    if (user.loginAttempts > 0) {
      await user.resetLoginAttempts();
    }
    <span class="comment">// Generate tokens</span>
    const accessToken = user.generateAuthToken();
    const refreshToken = user.generateRefreshToken();
    <span class="comment">// Set refresh token in HTTP-only cookie</span>
    res.cookie('refreshToken', refreshToken, {
      httpOnly: true,
      secure: process.env.NODE_ENV === 'production',
      sameSite: 'strict',
      maxAge: 30 * 24 * 60 * 60 * 1000 // 30 days
    });
    res.json({
      success: true,
      accessToken,
      user: {
        id: user._id,
        name: user.name,
        email: user.email,
        role: user.role,
        emailVerified: user.emailVerified
      }
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
};
<span class="comment">// Verify email</span>
exports.verifyEmail = async (req, res) => {
  try {
    const hashedToken = crypto
      .createHash('sha256')
      .update(req.params.token)
      .digest('hex');
    const user = await User.findOne({
      emailVerificationToken: hashedToken,
      emailVerificationExpire: { $gt: Date.now() }
    });
    if (!user) {
      return res.status(400).json({
        success: false,
        error: 'Invalid or expired verification token'
      });
    }
    user.emailVerified = true;
    user.emailVerificationToken = undefined;
    user.emailVerificationExpire = undefined;
    await user.save({ validateBeforeSave: false });
    res.json({
      success: true,
      message: 'Email verified successfully'
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
};
<span class="comment">// Forgot password</span>
exports.forgotPassword = async (req, res) => {
  try {
    const user = await User.findOne({ email: req.body.email });
    if (!user) {
      return res.status(404).json({
        success: false,
        error: 'No user found with that email'
      });
    }
    <span class="comment">// Generate reset token</span>
    const resetToken = user.generateResetPasswordToken();
    await user.save({ validateBeforeSave: false });
    <span class="comment">// Send reset email</span>
    const resetUrl = `${req.protocol}://${req.get('host')}/api/auth/reset-password/${resetToken}`;
    const message = `You requested a password reset. Please make a PUT request to: ${resetUrl}`;
    try {
      await sendEmail({
        email: user.email,
        subject: 'Password Reset',
        message
      });
      res.json({
        success: true,
        message: 'Password reset email sent'
      });
    } catch (error) {
      user.resetPasswordToken = undefined;
      user.resetPasswordExpire = undefined;
      await user.save({ validateBeforeSave: false });
      return res.status(500).json({
        success: false,
        error: 'Email could not be sent'
      });
    }
  } catch (error) {
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
};
<span class="comment">// Reset password</span>
exports.resetPassword = async (req, res) => {
  try {
    const hashedToken = crypto
      .createHash('sha256')
      .update(req.params.token)
      .digest('hex');
    const user = await User.findOne({
      resetPasswordToken: hashedToken,
      resetPasswordExpire: { $gt: Date.now() }
    });
    if (!user) {
      return res.status(400).json({
        success: false,
        error: 'Invalid or expired reset token'
      });
    }
    <span class="comment">// Set new password</span>
    user.password = req.body.password;
    user.resetPasswordToken = undefined;
    user.resetPasswordExpire = undefined;
    await user.save();
    <span class="comment">// Generate new tokens</span>
    const accessToken = user.generateAuthToken();
    const refreshToken = user.generateRefreshToken();
    res.json({
      success: true,
      message: 'Password reset successful',
      accessToken,
      refreshToken
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
};
<span class="comment">// Refresh access token</span>
exports.refreshToken = async (req, res) => {
  try {
    const { refreshToken } = req.cookies;
    if (!refreshToken) {
      return res.status(401).json({
        success: false,
        error: 'No refresh token provided'
      });
    }
    <span class="comment">// Verify refresh token</span>
    const decoded = jwt.verify(refreshToken, process.env.JWT_REFRESH_SECRET);
    <span class="comment">// Find user</span>
    const user = await User.findById(decoded.id);
    if (!user || !user.isActive) {
      return res.status(401).json({
        success: false,
        error: 'User not found or inactive'
      });
    }
    <span class="comment">// Generate new access token</span>
    const accessToken = user.generateAuthToken();
    res.json({
      success: true,
      accessToken
    });
  } catch (error) {
    res.status(403).json({
      success: false,
      error: 'Invalid or expired refresh token'
    });
  }
};
<span class="comment">// Logout</span>
exports.logout = async (req, res) => {
  res.cookie('refreshToken', '', {
    httpOnly: true,
    expires: new Date(0)
  });
  res.json({
    success: true,
    message: 'Logged out successfully'
  });
};
<span class="comment">// Get current user</span>
exports.getMe = async (req, res) => {
  try {
    const user = await User.findById(req.user.id);
    res.json({
      success: true,
      data: user
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
};
<span class="comment">// Update password</span>
exports.updatePassword = async (req, res) => {
  try {
    const user = await User.findById(req.user.id).select('+password');
    <span class="comment">// Check current password</span>
    const isPasswordValid = await user.comparePassword(req.body.currentPassword);
    if (!isPasswordValid) {
      return res.status(401).json({
        success: false,
        error: 'Current password is incorrect'
      });
    }
    <span class="comment">// Update password</span>
    user.password = req.body.newPassword;
    await user.save();
    <span class="comment">// Generate new tokens</span>
    const accessToken = user.generateAuthToken();
    const refreshToken = user.generateRefreshToken();
    res.json({
      success: true,
      message: 'Password updated successfully',
      accessToken,
      refreshToken
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
};
</pre>
                </div>
              </div>
              <div class="example-box">
                <h5>Example: Authentication Middleware</h5>
                <div class="code-box">
                  <pre><span class="comment">// middleware/auth.js</span>
const jwt = require('jsonwebtoken');
const User = require('../models/User');
<span class="comment">// Protect routes - verify JWT token</span>
exports.protect = async (req, res, next) => {
  try {
    let token;
    <span class="comment">// Get token from header</span>
    if (req.headers.authorization && req.headers.authorization.startsWith('Bearer')) {
      token = req.headers.authorization.split(' ')[1];
    }
    <span class="comment">// Check if token exists</span>
    if (!token) {
      return res.status(401).json({
        success: false,
        error: 'Not authorized to access this route'
      });
    }
    try {
      <span class="comment">// Verify token</span>
      const decoded = jwt.verify(token, process.env.JWT_SECRET);
      <span class="comment">// Get user from token</span>
      req.user = await User.findById(decoded.id);
      if (!req.user) {
        return res.status(401).json({
          success: false,
          error: 'User not found'
        });
      }
      <span class="comment">// Check if user is active</span>
      if (!req.user.isActive) {
        return res.status(401).json({
          success: false,
          error: 'Your account has been deactivated'
        });
      }
      <span class="comment">// Check if password was changed after token was issued</span>
      if (req.user.changedPasswordAfter(decoded.iat)) {
        return res.status(401).json({
          success: false,
          error: 'Password was recently changed. Please log in again.'
        });
      }
      next();
    } catch (error) {
      return res.status(401).json({
        success: false,
        error: 'Invalid or expired token'
      });
    }
  } catch (error) {
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
};
<span class="comment">// Authorize based on roles</span>
exports.authorize = (...roles) => {
  return (req, res, next) => {
    if (!roles.includes(req.user.role)) {
      return res.status(403).json({
        success: false,
        error: `User role '${req.user.role}' is not authorized to access this route`
      });
    }
    next();
  };
};
<span class="comment">// Verify email middleware</span>
exports.verifyEmail = (req, res, next) => {
  if (!req.user.emailVerified) {
    return res.status(403).json({
      success: false,
      error: 'Please verify your email to access this resource'
    });
  }
  next();
};
</pre>
                </div>
              </div>
            </div>
            <div class="section">
              <h3 class="section-title">8.2 OAuth 2.0 Implementation</h3>
              <div class="example-box">
                <h5>Example: Google OAuth with Passport.js</h5>
                <div class="code-box">
                  <pre>const passport = require('passport');
const GoogleStrategy = require('passport-google-oauth20').Strategy;
const User = require('../models/User');
<span class="comment">// Configure Google Strategy</span>
passport.use(new GoogleStrategy({
    clientID: process.env.GOOGLE_CLIENT_ID,
    clientSecret: process.env.GOOGLE_CLIENT_SECRET,
    callbackURL: '/api/auth/google/callback'
  },
  async (accessToken, refreshToken, profile, done) => {
    try {
      <span class="comment">// Check if user exists</span>
      let user = await User.findOne({ googleId: profile.id });
      if (user) {
        return done(null, user);
      }
      <span class="comment">// Check if user exists with same email</span>
      user = await User.findOne({ email: profile.emails[0].value });
      if (user) {
        <span class="comment">// Link Google account to existing user</span>
        user.googleId = profile.id;
        user.avatar = profile.photos[0].value;
        user.emailVerified = true;
        await user.save();
        return done(null, user);
      }
      <span class="comment">// Create new user</span>
      user = await User.create({
        googleId: profile.id,
        name: profile.displayName,
        email: profile.emails[0].value,
        avatar: profile.photos[0].value,
        emailVerified: true,
        password: crypto.randomBytes(32).toString('hex') // Random password
      });
      done(null, user);
    } catch (error) {
      done(error, null);
    }
  }
));
<span class="comment">// Serialize user for session</span>
passport.serializeUser((user, done) => {
  done(null, user.id);
});
<span class="comment">// Deserialize user from session</span>
passport.deserializeUser(async (id, done) => {
  try {
    const user = await User.findById(id);
    done(null, user);
  } catch (error) {
    done(error, null);
  }
});
<span class="comment">// Routes</span>
<span class="comment">// Initiate Google OAuth</span>
app.get('/api/auth/google',
  passport.authenticate('google', { scope: ['profile', 'email'] })
);
<span class="comment">// Google OAuth callback</span>
app.get('/api/auth/google/callback',
  passport.authenticate('google', { failureRedirect: '/login', session: false }),
  (req, res) => {
    <span class="comment">// Generate JWT tokens</span>
    const accessToken = req.user.generateAuthToken();
    const refreshToken = req.user.generateRefreshToken();
    <span class="comment">// Redirect to frontend with tokens</span>
    res.redirect(`${process.env.CLIENT_URL}/auth/success?token=${accessToken}&refresh=${refreshToken}`);
  }
);
</pre>
                </div>
              </div>
            </div>
            <div class="section">
              <h3 class="section-title">8.3 Two-Factor Authentication (2FA)</h3>
              <div class="example-box">
                <h5>Example: TOTP-Based 2FA</h5>
                <div class="code-box">
                  <pre>const speakeasy = require('speakeasy');
const qrcode = require('qrcode');
<span class="comment">// Add to User Schema</span>
twoFactorSecret: String,
twoFactorEnabled: {
  type: Boolean,
  default: false
}
<span class="comment">// Generate 2FA secret</span>
exports.generateTwoFactorSecret = async (req, res) => {
  try {
    const user = await User.findById(req.user.id);
    <span class="comment">// Generate secret</span>
    const secret = speakeasy.generateSecret({
      name: `MyApp (${user.email})`
    });
    <span class="comment">// Save secret to user (but don't enable yet)</span>
    user.twoFactorSecret = secret.base32;
    await user.save({ validateBeforeSave: false });
    <span class="comment">// Generate QR code</span>
    const qrCodeUrl = await qrcode.toDataURL(secret.otpauth_url);
    res.json({
      success: true,
      secret: secret.base32,
      qrCode: qrCodeUrl
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
};
<span class="comment">// Verify and enable 2FA</span>
exports.verifyAndEnableTwoFactor = async (req, res) => {
  try {
    const { token } = req.body;
    const user = await User.findById(req.user.id);
    if (!user.twoFactorSecret) {
      return res.status(400).json({
        success: false,
        error: 'Two-factor authentication not set up'
      });
    }
    <span class="comment">// Verify token</span>
    const verified = speakeasy.totp.verify({
      secret: user.twoFactorSecret,
      encoding: 'base32',
      token: token,
      window: 2
    });
    if (!verified) {
      return res.status(400).json({
        success: false,
        error: 'Invalid verification code'
      });
    }
    <span class="comment">// Enable 2FA</span>
    user.twoFactorEnabled = true;
    await user.save({ validateBeforeSave: false });
    res.json({
      success: true,
      message: 'Two-factor authentication enabled successfully'
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
};
<span class="comment">// Login with 2FA</span>
exports.loginWithTwoFactor = async (req, res) => {
  try {
    const { email, password, token } = req.body;
    <span class="comment">// Find user</span>
    const user = await User.findOne({ email }).select('+password');
    if (!user || !await user.comparePassword(password)) {
      return res.status(401).json({
        success: false,
        error: 'Invalid credentials'
      });
    }
    <span class="comment">// Check if 2FA is enabled</span>
    if (user.twoFactorEnabled) {
      if (!token) {
        return res.status(200).json({
          success: false,
          requiresTwoFactor: true,
          message: 'Two-factor authentication required'
        });
      }
      <span class="comment">// Verify 2FA token</span>
      const verified = speakeasy.totp.verify({
        secret: user.twoFactorSecret,
        encoding: 'base32',
        token: token,
        window: 2
      });
      if (!verified) {
        return res.status(401).json({
          success: false,
          error: 'Invalid two-factor code'
        });
      }
    }
    <span class="comment">// Generate tokens</span>
    const accessToken = user.generateAuthToken();
    const refreshToken = user.generateRefreshToken();
    res.json({
      success: true,
      accessToken,
      refreshToken,
      user: {
        id: user._id,
        name: user.name,
        email: user.email,
        role: user.role
      }
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
};
<span class="comment">// Disable 2FA</span>
exports.disableTwoFactor = async (req, res) => {
  try {
    const { token } = req.body;
    const user = await User.findById(req.user.id);
    <span class="comment">// Verify token before disabling</span>
    const verified = speakeasy.totp.verify({
      secret: user.twoFactorSecret,
      encoding: 'base32',
      token: token,
      window: 2
    });
    if (!verified) {
      return res.status(400).json({
        success: false,
        error: 'Invalid verification code'
      });
    }
    <span class="comment">// Disable 2FA</span>
    user.twoFactorEnabled = false;
    user.twoFactorSecret = undefined;
    await user.save({ validateBeforeSave: false });
    res.json({
      success: true,
      message: 'Two-factor authentication disabled successfully'
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
};
</pre>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div id="lesson9" class="lesson">
          <div class="lesson-header">
            <h2>Module 9: Advanced Topics</h2>
          </div>
          <div class="lesson-content">
            <div class="section">
              <h3 class="section-title">9.1 File Upload with Multer</h3>
              <div class="example-box">
                <h5>Example: Complete File Upload System</h5>
                <div class="code-box">
                  <pre>const multer = require('multer');
const path = require('path');
const fs = require('fs').promises;
<span class="comment">// Configure storage</span>
const storage = multer.diskStorage({
  destination: async (req, file, cb) => {
    const uploadDir = path.join(__dirname, '../uploads', req.user.id);
    <span class="comment">// Create directory if it doesn't exist</span>
    try {
      await fs.mkdir(uploadDir, { recursive: true });
      cb(null, uploadDir);
    } catch (error) {
      cb(error);
    }
  },
  filename: (req, file, cb) => {
    const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9);
    cb(null, file.fieldname + '-' + uniqueSuffix + path.extname(file.originalname));
  }
});
<span class="comment">// File filter</span>
const fileFilter = (req, file, cb) => {
  const allowedTypes = /jpeg|jpg|png|gif|pdf|doc|docx/;
  const extname = allowedTypes.test(path.extname(file.originalname).toLowerCase());
  const mimetype = allowedTypes.test(file.mimetype);
  if (extname && mimetype) {
    return cb(null, true);
  } else {
    cb(new Error('Invalid file type. Only JPEG, PNG, GIF, PDF, DOC, DOCX are allowed.'));
  }
};
<span class="comment">// Configure multer</span>
const upload = multer({
  storage: storage,
  limits: {
    fileSize: 5 * 1024 * 1024 // 5MB limit
  },
  fileFilter: fileFilter
});
<span class="comment">// Single file upload</span>
app.post('/api/upload/single',
  protect,
  upload.single('file'),
  async (req, res) => {
    try {
      if (!req.file) {
        return res.status(400).json({
          success: false,
          error: 'No file uploaded'
        });
      }
      res.json({
        success: true,
        message: 'File uploaded successfully',
        file: {
          filename: req.file.filename,
          originalname: req.file.originalname,
          mimetype: req.file.mimetype,
          size: req.file.size,
          path: req.file.path
        }
      });
    } catch (error) {
      res.status(500).json({
        success: false,
        error: error.message
      });
    }
  }
);
<span class="comment">// Multiple files upload</span>
app.post('/api/upload/multiple',
  protect,
  upload.array('files', 10), // Max 10 files
  async (req, res) => {
    try {
      if (!req.files || req.files.length === 0) {
        return res.status(400).json({
          success: false,
          error: 'No files uploaded'
        });
      }
      const uploadedFiles = req.files.map(file => ({
        filename: file.filename,
        originalname: file.originalname,
        mimetype: file.mimetype,
        size: file.size,
        path: file.path
      }));
      res.json({
        success: true,
        message: `${req.files.length} files uploaded successfully`,
        files: uploadedFiles
      });
    } catch (error) {
      res.status(500).json({
        success: false,
        error: error.message
      });
    }
  }
);
<span class="comment">// Multiple fields with files</span>
app.post('/api/upload/fields',
  protect,
  upload.fields([
    { name: 'avatar', maxCount: 1 },
    { name: 'gallery', maxCount: 8 }
  ]),
  async (req, res) => {
    try {
      res.json({
        success: true,
        avatar: req.files['avatar'] ? req.files['avatar'][0] : null,
        gallery: req.files['gallery'] || []
      });
    } catch (error) {
      res.status(500).json({
        success: false,
        error: error.message
      });
    }
  }
);
<span class="comment">// Error handling middleware for multer</span>
app.use((error, req, res, next) => {
  if (error instanceof multer.MulterError) {
    if (error.code === 'LIMIT_FILE_SIZE') {
      return res.status(400).json({
        success: false,
        error: 'File size too large. Maximum size is 5MB.'
      });
    }
    if (error.code === 'LIMIT_FILE_COUNT') {
      return res.status(400).json({
        success: false,
        error: 'Too many files uploaded.'
      });
    }
  }
  res.status(500).json({
    success: false,
    error: error.message
  });
});
<span class="comment">// Image upload with Sharp (resize/compress)</span>
const sharp = require('sharp');
app.post('/api/upload/image',
  protect,
  upload.single('image'),
  async (req, res) => {
    try {
      if (!req.file) {
        return res.status(400).json({
          success: false,
          error: 'No image uploaded'
        });
      }
      const filename = `resized-${Date.now()}.jpeg`;
      const outputPath = path.join(__dirname, '../uploads', req.user.id, filename);
      <span class="comment">// Resize and compress image</span>
      await sharp(req.file.path)
        .resize(800, 600, {
          fit: 'inside',
          withoutEnlargement: true
        })
        .jpeg({ quality: 90 })
        .toFile(outputPath);
      <span class="comment">// Delete original file</span>
      await fs.unlink(req.file.path);
      res.json({
        success: true,
        message: 'Image uploaded and processed successfully',
        file: {
          filename: filename,
          path: outputPath
        }
      });
    } catch (error) {
      res.status(500).json({
        success: false,
        error: error.message
      });
    }
  }
);
</pre>
                </div>
              </div>
            </div>
            <div class="section">
              <h3 class="section-title">9.2 Email Service</h3>
              <div class="example-box">
                <h5>Example: Email Service with Nodemailer</h5>
                <div class="code-box">
                  <pre><span class="comment">// utils/sendEmail.js</span>
const nodemailer = require('nodemailer');
const handlebars = require('handlebars');
const fs = require('fs').promises;
const path = require('path');
<span class="comment">// Create transporter</span>
const createTransporter = () => {
  if (process.env.NODE_ENV === 'production') {
    <span class="comment">// Production: Use real email service (SendGrid, AWS SES, etc.)</span>
    return nodemailer.createTransport({
      service: 'SendGrid',
      auth: {
        user: process.env.SENDGRID_USERNAME,
        pass: process.env.SENDGRID_API_KEY
      }
    });
  } else {
    <span class="comment">// Development: Use Ethereal (fake SMTP)</span>
    return nodemailer.createTransport({
      host: process.env.EMAIL_HOST,
      port: process.env.EMAIL_PORT,
      auth: {
        user: process.env.EMAIL_USERNAME,
        pass: process.env.EMAIL_PASSWORD
      }
    });
  }
};
<span class="comment">// Send email with template</span>
const sendEmail = async (options) => {
  try {
    const transporter = createTransporter();
    <span class="comment">// Load email template</span>
    const templatePath = path.join(__dirname, '../templates', `${options.template}.html`);
    const templateContent = await fs.readFile(templatePath, 'utf-8');
    <span class="comment">// Compile template with Handlebars</span>
    const template = handlebars.compile(templateContent);
    const html = template(options.context);
    <span class="comment">// Email options</span>
    const mailOptions = {
      from: `${process.env.FROM_NAME} <${process.env.FROM_EMAIL}>`,
      to: options.email,
      subject: options.subject,
      html: html,
      attachments: options.attachments || []
    };
    <span class="comment">// Send email</span>
    const info = await transporter.sendMail(mailOptions);
    console.log('Email sent:', info.messageId);
    if (process.env.NODE_ENV !== 'production') {
      console.log('Preview URL:', nodemailer.getTestMessageUrl(info));
    }
    return info;
  } catch (error) {
    console.error('Email error:', error);
    throw new Error('Email could not be sent');
  }
};
<span class="comment">// Send verification email</span>
const sendVerificationEmail = async (user, verificationToken) => {
  const verificationUrl = `${process.env.CLIENT_URL}/verify-email/${verificationToken}`;
  return await sendEmail({
    email: user.email,
    subject: 'Verify Your Email Address',
    template: 'emailVerification',
    context: {
      name: user.name,
      verificationUrl: verificationUrl,
      year: new Date().getFullYear()
    }
  });
};
<span class="comment">// Send password reset email</span>
const sendPasswordResetEmail = async (user, resetToken) => {
  const resetUrl = `${process.env.CLIENT_URL}/reset-password/${resetToken}`;
  return await sendEmail({
    email: user.email,
    subject: 'Password Reset Request',
    template: 'passwordReset',
    context: {
      name: user.name,
      resetUrl: resetUrl,
      expiryTime: '10 minutes',
      year: new Date().getFullYear()
    }
  });
};
<span class="comment">// Send welcome email</span>
const sendWelcomeEmail = async (user) => {
  return await sendEmail({
    email: user.email,
    subject: 'Welcome to Our Platform!',
    template: 'welcome',
    context: {
      name: user.name,
      dashboardUrl: `${process.env.CLIENT_URL}/dashboard`,
      year: new Date().getFullYear()
    }
  });
};
module.exports = {
  sendEmail,
  sendVerificationEmail,
  sendPasswordResetEmail,
  sendWelcomeEmail
};
<span class="comment">// Email Template Example (templates/emailVerification.html)</span>
/*
<!DOCTYPE html>
<html>
<head>
</head>
<body>
  <div class="container">
    <h2>Verify Your Email</h2>
    <p>Hi {{name}},</p>
    <p>Thank you for signing up! Please verify your email address by clicking the button below:</p>
    <p><a href="{{verificationUrl}}" class="button">Verify Email</a></p>
    <p>Or copy and paste this link into your browser:</p>
    <p>{{verificationUrl}}</p>
    <p>This link will expire in 24 hours.</p>
    <div class="footer">
      <p>&copy; {{year}} MyApp. All rights reserved.</p>
    </div>
  </div>
</body>
</html>
*/
</pre>
                </div>
              </div>
            </div>
            <div class="section">
              <h3 class="section-title">9.3 Testing with Jest and Supertest</h3>
              <div class="example-box">
                <h5>Example: API Testing</h5>
                <div class="code-box">
                  <pre><span class="comment">// tests/auth.test.js</span>
const request = require('supertest');
const app = require('../app');
const User = require('../models/User');
const mongoose = require('mongoose');
<span class="comment">// Setup and teardown</span>
beforeAll(async () => {
  await mongoose.connect(process.env.MONGO_TEST_URI);
});
afterAll(async () => {
  await User.deleteMany({});
  await mongoose.connection.close();
});
beforeEach(async () => {
  await User.deleteMany({});
});
describe('Authentication', () => {
  describe('POST /api/auth/register', () => {
    it('should register a new user', async () => {
      const userData = {
        name: 'Test User',
        email: 'test@example.com',
        password: 'password123'
      };
      const response = await request(app)
        .post('/api/auth/register')
        .send(userData)
        .expect(201);
      expect(response.body.success).toBe(true);
      expect(response.body.user.email).toBe(userData.email);
      expect(response.body.accessToken).toBeDefined();
      <span class="comment">// Verify user was created in database</span>
      const user = await User.findOne({ email: userData.email });
      expect(user).toBeDefined();
      expect(user.name).toBe(userData.name);
    });
    it('should not register user with existing email', async () => {
      <span class="comment">// Create user first</span>
      await User.create({
        name: 'Existing User',
        email: 'existing@example.com',
        password: 'password123'
      });
      const response = await request(app)
        .post('/api/auth/register')
        .send({
          name: 'New User',
          email: 'existing@example.com',
          password: 'password123'
        })
        .expect(400);
      expect(response.body.success).toBe(false);
      expect(response.body.error).toContain('exists');
    });
    it('should validate required fields', async () => {
      const response = await request(app)
        .post('/api/auth/register')
        .send({
          name: 'Test User'
          // Missing email and password
        })
        .expect(400);
      expect(response.body.success).toBe(false);
    });
  });
  describe('POST /api/auth/login', () => {
    let user;
    beforeEach(async () => {
      user = await User.create({
        name: 'Test User',
        email: 'test@example.com',
        password: 'password123'
      });
    });
    it('should login with valid credentials', async () => {
      const response = await request(app)
        .post('/api/auth/login')
        .send({
          email: 'test@example.com',
          password: 'password123'
        })
        .expect(200);
      expect(response.body.success).toBe(true);
      expect(response.body.accessToken).toBeDefined();
      expect(response.body.user.email).toBe(user.email);
    });
    it('should not login with invalid password', async () => {
      const response = await request(app)
        .post('/api/auth/login')
        .send({
          email: 'test@example.com',
          password: 'wrongpassword'
        })
        .expect(401);
      expect(response.body.success).toBe(false);
      expect(response.body.error).toContain('Invalid');
    });
    it('should not login with non-existent email', async () => {
      const response = await request(app)
        .post('/api/auth/login')
        .send({
          email: 'nonexistent@example.com',
          password: 'password123'
        })
        .expect(401);
      expect(response.body.success).toBe(false);
    });
  });
  describe('GET /api/auth/me', () => {
    let user;
    let token;
    beforeEach(async () => {
      user = await User.create({
        name: 'Test User',
        email: 'test@example.com',
        password: 'password123'
      });
      token = user.generateAuthToken();
    });
    it('should get current user with valid token', async () => {
      const response = await request(app)
        .get('/api/auth/me')
        .set('Authorization', `Bearer ${token}`)
        .expect(200);
      expect(response.body.success).toBe(true);
      expect(response.body.data.email).toBe(user.email);
    });
    it('should not get user without token', async () => {
      const response = await request(app)
        .get('/api/auth/me')
        .expect(401);
      expect(response.body.success).toBe(false);
    });
    it('should not get user with invalid token', async () => {
      const response = await request(app)
        .get('/api/auth/me')
        .set('Authorization', 'Bearer invalidtoken')
        .expect(401);
      expect(response.body.success).toBe(false);
    });
  });
});
<span class="comment">// Unit tests for models</span>
describe('User Model', () => {
  it('should hash password before saving', async () => {
    const user = new User({
      name: 'Test User',
      email: 'test@example.com',
      password: 'plainPassword123'
    });
    await user.save();
    expect(user.password).not.toBe('plainPassword123');
    expect(user.password).toMatch(/^\$2[aby]\$.{56}$/); // bcrypt hash format
  });
  it('should compare password correctly', async () => {
    const user = await User.create({
      name: 'Test User',
      email: 'test@example.com',
      password: 'password123'
    });
    const isMatch = await user.comparePassword('password123');
    expect(isMatch).toBe(true);
    const isNotMatch = await user.comparePassword('wrongpassword');
    expect(isNotMatch).toBe(false);
  });
  it('should generate valid JWT token', () => {
    const user = new User({
      _id: '507f1f77bcf86cd799439011',
      name: 'Test User',
      email: 'test@example.com',
      role: 'user'
    });
    const token = user.generateAuthToken();
    expect(token).toBeDefined();
    expect(typeof token).toBe('string');
  });
});
</pre>
                </div>
              </div>
            </div>
            <div class="section">
              <h3 class="section-title">9.4 Caching with Redis</h3>
              <div class="example-box">
                <h5>Example: Redis Caching Implementation</h5>
                <div class="code-box">
                  <pre>const redis = require('redis');
const { promisify } = require('util');
<span class="comment">// Create Redis client</span>
const redisClient = redis.createClient({
  host: process.env.REDIS_HOST || 'localhost',
  port: process.env.REDIS_PORT || 6379,
  password: process.env.REDIS_PASSWORD,
  retry_strategy: (options) => {
    if (options.error && options.error.code === 'ECONNREFUSED') {
      return new Error('Redis server refused connection');
    }
    if (options.total_retry_time > 1000 * 60 * 60) {
      return new Error('Redis retry time exhausted');
    }
    if (options.attempt > 10) {
      return undefined;
    }
    return Math.min(options.attempt * 100, 3000);
  }
});
<span class="comment">// Handle Redis events</span>
redisClient.on('connect', () => {
  console.log('Redis client connected');
});
redisClient.on('error', (err) => {
  console.error('Redis error:', err);
});
<span class="comment">// Promisify Redis methods</span>
const getAsync = promisify(redisClient.get).bind(redisClient);
const setAsync = promisify(redisClient.set).bind(redisClient);
const delAsync = promisify(redisClient.del).bind(redisClient);
const existsAsync = promisify(redisClient.exists).bind(redisClient);
<span class="comment">// Cache middleware</span>
const cache = (duration = 3600) => {
  return async (req, res, next) => {
    if (!redisClient.connected) {
      return next();
    }
    const key = `cache:${req.originalUrl}`;
    try {
      const cachedResponse = await getAsync(key);
      if (cachedResponse) {
        console.log('Cache hit:', key);
        return res.json(JSON.parse(cachedResponse));
      }
      console.log('Cache miss:', key);
      <span class="comment">// Store original res.json method</span>
      const originalJson = res.json.bind(res);
      <span class="comment">// Override res.json to cache response</span>
      res.json = (body) => {
        setAsync(key, JSON.stringify(body), 'EX', duration);
        return originalJson(body);
      };
      next();
    } catch (error) {
      console.error('Cache error:', error);
      next();
    }
  };
};
<span class="comment">// Clear cache for specific pattern</span>
const clearCache = async (pattern) => {
  return new Promise((resolve, reject) => {
    redisClient.keys(pattern, (err, keys) => {
      if (err) return reject(err);
      if (keys.length === 0) return resolve(0);
      redisClient.del(...keys, (err, count) => {
        if (err) return reject(err);
        resolve(count);
      });
    });
  });
};
<span class="comment">// Usage in routes</span>
<span class="comment">// Cache for 1 hour</span>
app.get('/api/users', cache(3600), async (req, res) => {
  const users = await User.find();
  res.json({ success: true, data: users });
});
<span class="comment">// Clear cache on update</span>
app.put('/api/users/:id', protect, async (req, res) => {
  const user = await User.findByIdAndUpdate(req.params.id, req.body, { new: true });
  <span class="comment">// Clear related cache</span>
  await clearCache('cache:/api/users*');
  res.json({ success: true, data: user });
});
<span class="comment">// Session caching</span>
const setUserSession = async (userId, sessionData, ttl = 86400) => {
  const key = `session:${userId}`;
  await setAsync(key, JSON.stringify(sessionData), 'EX', ttl);
};
const getUserSession = async (userId) => {
  const key = `session:${userId}`;
  const session = await getAsync(key);
  return session ? JSON.parse(session) : null;
};
const deleteUserSession = async (userId) => {
  const key = `session:${userId}`;
  await delAsync(key);
};
<span class="comment">// Rate limiting with Redis</span>
const rateLimiter = (maxRequests = 100, windowMs = 60000) => {
  return async (req, res, next) => {
    const key = `ratelimit:${req.ip}`;
    try {
      const current = await getAsync(key);
      if (current === null) {
        await setAsync(key, 1, 'PX', windowMs);
        return next();
      }
      if (parseInt(current) >= maxRequests) {
        return res.status(429).json({
          success: false,
          error: 'Too many requests. Please try again later.'
        });
      }
      redisClient.incr(key);
      next();
    } catch (error) {
      console.error('Rate limiter error:', error);
      next();
    }
  };
};
app.use('/api', rateLimiter(100, 60000));
module.exports = {
  redisClient,
  cache,
  clearCache,
  setUserSession,
  getUserSession,
  deleteUserSession,
  rateLimiter
};
</pre>
                </div>
              </div>
            </div>
            <div class="section">
              <h3 class="section-title">9.5 WebSocket Real-Time Communication</h3>
              <div class="example-box">
                <h5>Example: Socket.io Implementation</h5>
                <div class="code-box">
                  <pre>const express = require('express');
const http = require('http');
const socketIo = require('socket.io');
const jwt = require('jsonwebtoken');
const app = express();
const server = http.createServer(app);
const io = socketIo(server, {
  cors: {
    origin: process.env.CLIENT_URL,
    methods: ['GET', 'POST']
  }
});
<span class="comment">// Socket authentication middleware</span>
io.use((socket, next) => {
  const token = socket.handshake.auth.token;
  if (!token) {
    return next(new Error('Authentication error'));
  }
  try {
    const decoded = jwt.verify(token, process.env.JWT_SECRET);
    socket.userId = decoded.id;
    next();
  } catch (error) {
    next(new Error('Authentication error'));
  }
});
<span class="comment">// Store active users</span>
const activeUsers = new Map();
<span class="comment">// Socket.io event handlers</span>
io.on('connection', (socket) => {
  console.log('User connected:', socket.userId);
  <span class="comment">// Add user to active users</span>
  activeUsers.set(socket.userId, socket.id);
  <span class="comment">// Broadcast to all users that someone joined</span>
  socket.broadcast.emit('user-connected', {
    userId: socket.userId,
    timestamp: new Date()
  });
  <span class="comment">// Join user-specific room</span>
  socket.join(`user:${socket.userId}`);
  <span class="comment">// Join a chat room</span>
  socket.on('join-room', (roomId) => {
    socket.join(`room:${roomId}`);
    socket.to(`room:${roomId}`).emit('user-joined-room', {
      userId: socket.userId,
      roomId: roomId
    });
  });
  <span class="comment">// Leave a chat room</span>
  socket.on('leave-room', (roomId) => {
    socket.leave(`room:${roomId}`);
    socket.to(`room:${roomId}`).emit('user-left-room', {
      userId: socket.userId,
      roomId: roomId
    });
  });
  <span class="comment">// Handle chat message</span>
  socket.on('send-message', async (data) => {
    const { roomId, message } = data;
    <span class="comment">// Save message to database</span>
    const newMessage = await Message.create({
      room: roomId,
      sender: socket.userId,
      content: message,
      timestamp: new Date()
    });
    <span class="comment">// Broadcast to room</span>
    io.to(`room:${roomId}`).emit('new-message', {
      id: newMessage._id,
      roomId: roomId,
      sender: socket.userId,
      content: message,
      timestamp: newMessage.timestamp
    });
  });
  <span class="comment">// Handle typing indicator</span>
  socket.on('typing-start', (roomId) => {
    socket.to(`room:${roomId}`).emit('user-typing', {
      userId: socket.userId,
      roomId: roomId
    });
  });
  socket.on('typing-stop', (roomId) => {
    socket.to(`room:${roomId}`).emit('user-stopped-typing', {
      userId: socket.userId,
      roomId: roomId
    });
  });
  <span class="comment">// Handle private message</span>
  socket.on('send-private-message', async (data) => {
    const { recipientId, message } = data;
    const newMessage = await Message.create({
      sender: socket.userId,
      recipient: recipientId,
      content: message,
      timestamp: new Date()
    });
    <span class="comment">// Send to recipient if online</span>
    const recipientSocketId = activeUsers.get(recipientId);
    if (recipientSocketId) {
      io.to(recipientSocketId).emit('private-message', {
        id: newMessage._id,
        sender: socket.userId,
        content: message,
        timestamp: newMessage.timestamp
      });
    }
      <span class="comment">// Send confirmation to sender</span>
    socket.emit('message-sent', {
      id: newMessage._id,
      recipientId: recipientId,
      delivered: !!recipientSocketId
    });
  });
  <span class="comment">// Handle video call signaling</span>
  socket.on('call-user', (data) => {
    const { recipientId, offer } = data;
    const recipientSocketId = activeUsers.get(recipientId);
    if (recipientSocketId) {
      io.to(recipientSocketId).emit('incoming-call', {
        callerId: socket.userId,
        offer: offer
      });
    } else {
      socket.emit('user-offline', { recipientId });
    }
  });
  socket.on('answer-call', (data) => {
    const { callerId, answer } = data;
    const callerSocketId = activeUsers.get(callerId);
    if (callerSocketId) {
      io.to(callerSocketId).emit('call-answered', {
        answer: answer
      });
    }
  });
  socket.on('ice-candidate', (data) => {
    const { recipientId, candidate } = data;
    const recipientSocketId = activeUsers.get(recipientId);
    if (recipientSocketId) {
      io.to(recipientSocketId).emit('ice-candidate', {
        candidate: candidate,
        senderId: socket.userId
      });
    }
  });
  <span class="comment">// Handle disconnect</span>
  socket.on('disconnect', () => {
    console.log('User disconnected:', socket.userId);
    <span class="comment">// Remove from active users</span>
    activeUsers.delete(socket.userId);
    <span class="comment">// Broadcast to all users</span>
    socket.broadcast.emit('user-disconnected', {
      userId: socket.userId,
      timestamp: new Date()
    });
  });
  <span class="comment">// Handle errors</span>
  socket.on('error', (error) => {
    console.error('Socket error:', error);
  });
});
<span class="comment">// Send notification to specific user from REST API</span>
const sendNotificationToUser = (userId, notification) => {
  const socketId = activeUsers.get(userId);
  if (socketId) {
    io.to(socketId).emit('notification', notification);
    return true;
  }
  return false;
};
<span class="comment">// Broadcast to all connected users</span>
const broadcastToAll = (event, data) => {
  io.emit(event, data);
};
<span class="comment">// Send to specific room</span>
const sendToRoom = (roomId, event, data) => {
  io.to(`room:${roomId}`).emit(event, data);
};
<span class="comment">// Get online users count</span>
const getOnlineUsersCount = () => {
  return activeUsers.size;
};
<span class="comment">// Example: Trigger socket event from REST endpoint</span>
app.post('/api/notifications/send', protect, async (req, res) => {
  const { userId, message } = req.body;
  const notification = {
    id: Date.now(),
    message: message,
    timestamp: new Date()
  };
  const delivered = sendNotificationToUser(userId, notification);
  res.json({
    success: true,
    delivered: delivered,
    message: delivered ? 'Notification sent' : 'User offline, notification queued'
  });
});
server.listen(PORT, () => {
  console.log(`Server with WebSocket running on port ${PORT}`);
});
module.exports = {
  io,
  sendNotificationToUser,
  broadcastToAll,
  sendToRoom,
  getOnlineUsersCount
};
</pre>
                </div>
              </div>
            </div>
            <div class="section">
              <h3 class="section-title">9.6 Logging with Winston</h3>
              <div class="example-box">
                <h5>Example: Professional Logging Setup</h5>
                <div class="code-box">
                  <pre><span class="comment">// utils/logger.js</span>
const winston = require('winston');
const path = require('path');
<span class="comment">// Define log levels</span>
const levels = {
  error: 0,
  warn: 1,
  info: 2,
  http: 3,
  debug: 4
};
<span class="comment">// Define colors for each level</span>
const colors = {
  error: 'red',
  warn: 'yellow',
  info: 'green',
  http: 'magenta',
  debug: 'white'
};
winston.addColors(colors);
<span class="comment">// Define log format</span>
const format = winston.format.combine(
  winston.format.timestamp({ format: 'YYYY-MM-DD HH:mm:ss' }),
  winston.format.errors({ stack: true }),
  winston.format.splat(),
  winston.format.json()
);
<span class="comment">// Define which transports to use</span>
const transports = [
  <span class="comment">// Console transport</span>
  new winston.transports.Console({
    format: winston.format.combine(
      winston.format.colorize({ all: true }),
      winston.format.printf((info) => {
        const { timestamp, level, message, ...args } = info;
        return `${timestamp} [${level}]: ${message} ${
          Object.keys(args).length ? JSON.stringify(args, null, 2) : ''
        }`;
      })
    )
  }),
  <span class="comment">// File transport for errors</span>
  new winston.transports.File({
    filename: path.join(__dirname, '../logs/error.log'),
    level: 'error',
    maxsize: 5242880, // 5MB
    maxFiles: 5
  }),
  <span class="comment">// File transport for all logs</span>
  new winston.transports.File({
    filename: path.join(__dirname, '../logs/combined.log'),
    maxsize: 5242880,
    maxFiles: 5
  })
];
<span class="comment">// Create logger instance</span>
const logger = winston.createLogger({
  level: process.env.NODE_ENV === 'production' ? 'info' : 'debug',
  levels,
  format,
  transports,
  exceptionHandlers: [
    new winston.transports.File({
      filename: path.join(__dirname, '../logs/exceptions.log')
    })
  ],
  rejectionHandlers: [
    new winston.transports.File({
      filename: path.join(__dirname, '../logs/rejections.log')
    })
  ]
});
<span class="comment">// Create stream for Morgan HTTP logging</span>
logger.stream = {
  write: (message) => {
    logger.http(message.trim());
  }
};
module.exports = logger;
<span class="comment">// Usage in app.js</span>
const logger = require('./utils/logger');
const morgan = require('morgan');
<span class="comment">// HTTP request logging</span>
app.use(morgan('combined', { stream: logger.stream }));
<span class="comment">// Log examples</span>
logger.error('This is an error message', { error: new Error('Something went wrong') });
logger.warn('This is a warning message');
logger.info('This is an info message', { userId: '12345', action: 'login' });
logger.http('HTTP request logged');
logger.debug('Debug information', { data: { key: 'value' } });
<span class="comment">// Logging middleware</span>
const logRequest = (req, res, next) => {
  logger.info(`${req.method} ${req.url}`, {
    ip: req.ip,
    userId: req.user ? req.user.id : 'anonymous',
    userAgent: req.get('user-agent')
  });
  next();
};
app.use(logRequest);
<span class="comment">// Error logging middleware</span>
app.use((err, req, res, next) => {
  logger.error('Error occurred', {
    error: err.message,
    stack: err.stack,
    url: req.url,
    method: req.method,
    ip: req.ip,
    userId: req.user ? req.user.id : 'anonymous'
  });
  res.status(err.statusCode || 500).json({
    success: false,
    error: process.env.NODE_ENV === 'production' 
      ? 'Internal server error' 
      : err.message
  });
});
</pre>
                </div>
              </div>
            </div>
            <div class="section">
              <h3 class="section-title">9.7 API Documentation with Swagger</h3>
              <div class="example-box">
                <h5>Example: Swagger Setup</h5>
                <div class="code-box">
                  <pre>const swaggerJsDoc = require('swagger-jsdoc');
const swaggerUi = require('swagger-ui-express');
<span class="comment">// Swagger configuration</span>
const swaggerOptions = {
  definition: {
    openapi: '3.0.0',
    info: {
      title: 'My API Documentation',
      version: '1.0.0',
      description: 'A comprehensive API documentation',
      contact: {
        name: 'API Support',
        email: 'support@example.com'
      },
      license: {
        name: 'MIT',
        url: 'https://opensource.org/licenses/MIT'
      }
    },
    servers: [
      {
        url: 'http://localhost:3000',
        description: 'Development server'
      },
      {
        url: 'https://api.example.com',
        description: 'Production server'
      }
    ],
    components: {
      securitySchemes: {
        bearerAuth: {
          type: 'http',
          scheme: 'bearer',
          bearerFormat: 'JWT'
        }
      },
      schemas: {
        User: {
          type: 'object',
          required: ['name', 'email', 'password'],
          properties: {
            id: {
              type: 'string',
              description: 'User ID'
            },
            name: {
              type: 'string',
              description: 'User name'
            },
            email: {
              type: 'string',
              format: 'email',
              description: 'User email'
            },
            role: {
              type: 'string',
              enum: ['user', 'admin', 'moderator'],
              description: 'User role'
            },
            createdAt: {
              type: 'string',
              format: 'date-time',
              description: 'Creation timestamp'
            }
          }
        },
        Error: {
          type: 'object',
          properties: {
            success: {
              type: 'boolean',
              example: false
            },
            error: {
              type: 'string',
              description: 'Error message'
            }
          }
        }
      }
    },
    security: [
      {
        bearerAuth: []
      }
    ]
  },
  apis: ['./routes/*.js', './controllers/*.js']
};
const swaggerDocs = swaggerJsDoc(swaggerOptions);
<span class="comment">// Serve Swagger UI</span>
app.use('/api-docs', swaggerUi.serve, swaggerUi.setup(swaggerDocs, {
  customCss: '.swagger-ui .topbar { display: none }',
  customSiteTitle: 'My API Documentation'
}));
<span class="comment">// Route documentation examples</span>
/**
 * @swagger
 * /api/auth/register:
 *   post:
 *     summary: Register a new user
 *     tags: [Authentication]
 *     requestBody:
 *       required: true
 *       content:
 *         application/json:
 *           schema:
 *             type: object
 *             required:
 *               - name
 *               - email
 *               - password
 *             properties:
 *               name:
 *                 type: string
 *                 example: John Doe
 *               email:
 *                 type: string
 *                 format: email
 *                 example: john@example.com
 *               password:
 *                 type: string
 *                 format: password
 *                 minLength: 8
 *                 example: password123
 *     responses:
 *       201:
 *         description: User registered successfully
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 success:
 *                   type: boolean
 *                   example: true
 *                 accessToken:
 *                   type: string
 *                 user:
 *                   $ref: '#/components/schemas/User'
 *       400:
 *         description: Invalid input
 *         content:
 *           application/json:
 *             schema:
 *               $ref: '#/components/schemas/Error'
 */
app.post('/api/auth/register', authController.register);
/**
 * @swagger
 * /api/users:
 *   get:
 *     summary: Get all users
 *     tags: [Users]
 *     security:
 *       - bearerAuth: []
 *     parameters:
 *       - in: query
 *         name: page
 *         schema:
 *           type: integer
 *           default: 1
 *         description: Page number
 *       - in: query
 *         name: limit
 *         schema:
 *           type: integer
 *           default: 10
 *         description: Items per page
 *       - in: query
 *         name: sort
 *         schema:
 *           type: string
 *           default: createdAt
 *         description: Sort field
 *     responses:
 *       200:
 *         description: List of users
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 success:
 *                   type: boolean
 *                   example: true
 *                 count:
 *                   type: integer
 *                   example: 50
 *                 pagination:
 *                   type: object
 *                   properties:
 *                     page:
 *                       type: integer
 *                     limit:
 *                       type: integer
 *                     total:
 *                       type: integer
 *                     pages:
 *                       type: integer
 *                 data:
 *                   type: array
 *                   items:
 *                     $ref: '#/components/schemas/User'
 *       401:
 *         description: Unauthorized
 *         content:
 *           application/json:
 *             schema:
 *               $ref: '#/components/schemas/Error'
 */
app.get('/api/users', protect, userController.getUsers);
/**
 * @swagger
 * /api/users/{id}:
 *   get:
 *     summary: Get user by ID
 *     tags: [Users]
 *     security:
 *       - bearerAuth: []
 *     parameters:
 *       - in: path
 *         name: id
 *         required: true
 *         schema:
 *           type: string
 *         description: User ID
 *     responses:
 *       200:
 *         description: User found
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 success:
 *                   type: boolean
 *                   example: true
 *                 data:
 *                   $ref: '#/components/schemas/User'
 *       404:
 *         description: User not found
 *         content:
 *           application/json:
 *             schema:
 *               $ref: '#/components/schemas/Error'
 */
app.get('/api/users/:id', protect, userController.getUser);
</pre>
                </div>
              </div>
            </div>
            <div class="section">
              <h3 class="section-title">9.8 Deployment Best Practices</h3>
              <div class="component-grid">
                <div class="component-card">
                  <h4><i class="fas fa-lock"></i> Environment Variables</h4>
                  <p style="text-align: left; font-size: 0.9em; margin-top: 10px;">
                    Use .env files for development, environment-specific configs for production
                  </p>
                </div>
                <div class="component-card">
                  <h4><i class="fas fa-sync"></i> Process Managers</h4>
                  <p style="text-align: left; font-size: 0.9em; margin-top: 10px;">
                    Use PM2 or forever to keep app running and auto-restart on crashes
                  </p>
                </div>
                <div class="component-card">
                  <h4><i class="fas fa-chart-bar"></i> Monitoring</h4>
                  <p style="text-align: left; font-size: 0.9em; margin-top: 10px;">
                    Implement logging, error tracking (Sentry), and performance monitoring
                  </p>
                </div>
                <div class="component-card">
                  <h4><i class="fas fa-lock"></i> Security</h4>
                  <p style="text-align: left; font-size: 0.9em; margin-top: 10px;">
                    Use Helmet, rate limiting, input validation, and HTTPS
                  </p>
                </div>
                <div class="component-card">
                  <h4><i class="fas fa-bolt"></i> Performance</h4>
                  <p style="text-align: left; font-size: 0.9em; margin-top: 10px;">
                    Enable compression, caching, CDN for static assets
                  </p>
                </div>
                <div class="component-card">
                  <h4><i class="fas fa-star"></i> Containerization</h4>
                  <p style="text-align: left; font-size: 0.9em; margin-top: 10px;">
                    Use Docker for consistent deployments across environments
                  </p>
                </div>
              </div>
              <div class="example-box">
                <h5>Example: PM2 Configuration</h5>
                <div class="code-box">
                  <pre><span class="comment">// ecosystem.config.js</span>
module.exports = {
  apps: [
    {
      name: 'my-api',
      script: './server.js',
      instances: 'max', // Use all CPU cores
      exec_mode: 'cluster',
      env: {
        NODE_ENV: 'development',
        PORT: 3000
      },
      env_production: {
        NODE_ENV: 'production',
        PORT: 8080
      },
      error_file: './logs/pm2-error.log',
      out_file: './logs/pm2-out.log',
      log_date_format: 'YYYY-MM-DD HH:mm:ss Z',
      max_memory_restart: '1G',
      watch: false,
      ignore_watch: ['node_modules', 'logs'],
      autorestart: true,
      max_restarts: 10,
      min_uptime: '10s'
    }
  ]
};
<span class="comment">// Commands</span>
<span class="comment">// Start app</span>
pm2 start ecosystem.config.js --env production
<span class="comment">// Monitor</span>
pm2 monit
<span class="comment">// View logs</span>
pm2 logs
<span class="comment">// Restart app</span>
pm2 restart my-api
<span class="comment">// Stop app</span>
pm2 stop my-api
<span class="comment">// Delete app from PM2</span>
pm2 delete my-api
<span class="comment">// Save current process list</span>
pm2 save
<span class="comment">// Auto-start on system boot</span>
pm2 startup
</pre>
                </div>
              </div>
              <div class="example-box">
                <h5>Example: Dockerfile</h5>
                <div class="code-box">
                  <pre><span class="comment"># Dockerfile</span>
FROM node:18-alpine
<span class="comment"># Create app directory</span>
WORKDIR /usr/src/app
<span class="comment"># Copy package files</span>
COPY package*.json ./
<span class="comment"># Install dependencies</span>
RUN npm ci --only=production
<span class="comment"># Copy app source</span>
COPY . .
<span class="comment"># Create non-root user</span>
RUN addgroup -g 1001 -S nodejs && \
    adduser -S nodejs -u 1001 && \
    chown -R nodejs:nodejs /usr/src/app
<span class="comment"># Switch to non-root user</span>
USER nodejs
<span class="comment"># Expose port</span>
EXPOSE 3000
<span class="comment"># Health check</span>
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD node healthcheck.js
<span class="comment"># Start app</span>
CMD ["node", "server.js"]
<span class="comment"># docker-compose.yml</span>
version: '3.8'
services:
  api:
    build: .
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - PORT=3000
      - MONGO_URI=${MONGO_URI}
      - JWT_SECRET=${JWT_SECRET}
    depends_on:
      - mongodb
      - redis
    restart: unless-stopped
    networks:
      - app-network
  mongodb:
    image: mongo:7
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_USERNAME}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_PASSWORD}
    networks:
      - app-network
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - app-network
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - api
    networks:
      - app-network
volumes:
  mongodb_data:
  redis_data:
networks:
  app-network:
    driver: bridge
</pre>
                </div>
              </div>
              <div class="example-box">
                <h5>Production Checklist</h5>
                <div class="content-box">
                  <ul>
                    <li><i class="fas fa-check"></i> Use environment variables for all sensitive data</li>
                    <li><i class="fas fa-check"></i> Enable HTTPS/SSL certificates</li>
                    <li><i class="fas fa-check"></i> Set NODE_ENV=production</li>
                    <li><i class="fas fa-check"></i> Enable compression and caching</li>
                    <li><i class="fas fa-check"></i> Implement rate limiting</li>
                    <li><i class="fas fa-check"></i> Use security headers (Helmet)</li>
                    <li><i class="fas fa-check"></i> Configure CORS properly</li>
                    <li><i class="fas fa-check"></i> Set up logging and monitoring</li>
                    <li><i class="fas fa-check"></i> Implement error tracking (Sentry, Rollbar)</li>
                    <li><i class="fas fa-check"></i> Use a process manager (PM2)</li>
                    <li><i class="fas fa-check"></i> Set up database backups</li>
                    <li><i class="fas fa-check"></i> Configure firewall rules</li>
                    <li><i class="fas fa-check"></i> Keep dependencies updated</li>
                    <li><i class="fas fa-check"></i> Run security audits (npm audit)</li>
                    <li><i class="fas fa-check"></i> Set up CI/CD pipeline</li>
                    <li><i class="fas fa-check"></i> Load testing before deployment</li>
                    <li><i class="fas fa-check"></i> Documentation (API docs, README)</li>
                    <li><i class="fas fa-check"></i> Health check endpoints</li>
                    <li><i class="fas fa-check"></i> Graceful shutdown handling</li>
                  </ul>
                </div>
              </div>
            </div>
            <div class="section">
              <h3 class="section-title">9.9 Performance Optimization Tips</h3>
              <div class="component-grid">
                <div class="component-card">
                  <h4>1<i class="fas fa-star"></i> Database Optimization</h4>
                  <p style="text-align: left; font-size: 0.9em; margin-top: 10px;">
                    Use indexes, query optimization, connection pooling
                  </p>
                </div>
                <div class="component-card">
                  <h4>2<i class="fas fa-star"></i> Caching Strategy</h4>
                  <p style="text-align: left; font-size: 0.9em; margin-top: 10px;">
                    Redis caching, CDN for static assets, HTTP caching headers
                  </p>
                </div>
                <div class="component-card">
                  <h4>3<i class="fas fa-star"></i> Async Operations</h4>
                  <p style="text-align: left; font-size: 0.9em; margin-top: 10px;">
                    Use async/await, Promise.all for parallel operations
                  </p>
                </div>
                <div class="component-card">
                  <h4>4<i class="fas fa-star"></i> Compression</h4>
                  <p style="text-align: left; font-size: 0.9em; margin-top: 10px;">
                    Enable Gzip/Brotli compression for responses
                  </p>
                </div>
                <div class="component-card">
                  <h4>5<i class="fas fa-star"></i> Load Balancing</h4>
                  <p style="text-align: left; font-size: 0.9em; margin-top: 10px;">
                    Use Nginx, cluster mode, horizontal scaling
                  </p>
                </div>
                <div class="component-card">
                  <h4>6<i class="fas fa-star"></i> Code Optimization</h4>
                  <p style="text-align: left; font-size: 0.9em; margin-top: 10px;">
                    Avoid blocking operations, optimize algorithms
                  </p>
                </div>
              </div>
              <div class="example-box">
                <h5>Performance Monitoring</h5>
                <div class="code-box">
                  <pre><span class="comment">// Performance monitoring middleware</span>
const performanceMonitor = (req, res, next) => {
  const start = Date.now();
  res.on('finish', () => {
    const duration = Date.now() - start;
    logger.info('Request completed', {
      method: req.method,
      url: req.url,
      statusCode: res.statusCode,
      duration: `${duration}ms`,
      userId: req.user ? req.user.id : 'anonymous'
    });
    <span class="comment">// Alert if request takes too long</span>
    if (duration > 1000) {
      logger.warn('Slow request detected', {
        method: req.method,
        url: req.url,
        duration: `${duration}ms`
      });
    }
  });
  next();
};
app.use(performanceMonitor);
<span class="comment">// Memory monitoring</span>
setInterval(() => {
  const memoryUsage = process.memoryUsage();
  logger.info('Memory usage', {
    rss: `${Math.round(memoryUsage.rss / 1024 / 1024)}MB`,
    heapTotal: `${Math.round(memoryUsage.heapTotal / 1024 / 1024)}MB`,
    heapUsed: `${Math.round(memoryUsage.heapUsed / 1024 / 1024)}MB`,
    external: `${Math.round(memoryUsage.external / 1024 / 1024)}MB`
  });
  <span class="comment">// Alert if memory usage is high</span>
  if (memoryUsage.heapUsed > 500 * 1024 * 1024) { // 500MB
    logger.warn('High memory usage detected');
  }
}, 60000); // Check every minute
</pre>
                </div>
              </div>
            </div>
            <div class="section">
              <h3 class="section-title">9.10 Useful NPM Packages Reference</h3>
              <table class="comparison-table">
                <thead>
                  <tr>
                    <th>Category</th>
                    <th>Package</th>
                    <th>Purpose</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td rowspan="3"><strong>Web Framework</strong></td>
                    <td>express</td>
                    <td>Fast, minimalist web framework</td>
                  </tr>
                  <tr>
                    <td>fastify</td>
                    <td>Fast and low overhead web framework</td>
                  </tr>
                  <tr>
                    <td>koa</td>
                    <td>Next generation web framework</td>
                  </tr>
                  <tr>
                    <td rowspan="3"><strong>Database</strong></td>
                    <td>mongoose</td>
                    <td>MongoDB ODM</td>
                  </tr>
                  <tr>
                    <td>pg</td>
                    <td>PostgreSQL client</td>
                  </tr>
                  <tr>
                    <td>sequelize</td>
                    <td>SQL ORM (PostgreSQL, MySQL, SQLite)</td>
                  </tr>
                  <tr>
                    <td rowspan="4"><strong>Authentication</strong></td>
                    <td>jsonwebtoken</td>
                    <td>JWT implementation</td>
                  </tr>
                  <tr>
                    <td>bcryptjs</td>
                    <td>Password hashing</td>
                  </tr>
                  <tr>
                    <td>passport</td>
                    <td>Authentication middleware</td>
                  </tr>
                  <tr>
                    <td>speakeasy</td>
                    <td>Two-factor authentication (TOTP)</td>
                  </tr>
                  <tr>
                    <td rowspan="3"><strong>Validation</strong></td>
                    <td>joi</td>
                    <td>Schema validation</td>
                  </tr>
                  <tr>
                    <td>express-validator</td>
                    <td>Express middleware for validation</td>
                  </tr>
                  <tr>
                    <td>yup</td>
                    <td>Schema validation</td>
                  </tr>
                  <tr>
                    <td rowspan="4"><strong>Security</strong></td>
                    <td>helmet</td>
                    <td>Security headers</td>
                  </tr>
                  <tr>
                    <td>express-rate-limit</td>
                    <td>Rate limiting</td>
                  </tr>
                  <tr>
                    <td>cors</td>
                    <td>CORS middleware</td>
                  </tr>
                  <tr>
                    <td>xss-clean</td>
                    <td>XSS protection</td>
                  </tr>
                  <tr>
                    <td rowspan="3"><strong>Utilities</strong></td>
                    <td>dotenv</td>
                    <td>Environment variables</td>
                  </tr>
                  <tr>
                    <td>moment</td>
                    <td>Date manipulation</td>
                  </tr>
                  <tr>
                    <td>lodash</td>
                    <td>Utility functions</td>
                  </tr>
                  <tr>
                    <td rowspan="2"><strong>File Upload</strong></td>
                    <td>multer</td>
                    <td>Multipart/form-data handling</td>
                  </tr>
                  <tr>
                    <td>sharp</td>
                    <td>Image processing</td>
                  </tr>
                  <tr>
                    <td rowspan="2"><strong>Email</strong></td>
                    <td>nodemailer</td>
                    <td>Email sending</td>
                  </tr>
                  <tr>
                    <td>handlebars</td>
                    <td>Email templates</td>
                  </tr>
                  <tr>
                    <td rowspan="3"><strong>Testing</strong></td>
                    <td>jest</td>
                    <td>Testing framework</td>
                  </tr>
                  <tr>
                    <td>supertest</td>
                    <td>HTTP testing</td>
                  </tr>
                  <tr>
                    <td>mocha</td>
                    <td>Testing framework</td>
                  </tr>
                  <tr>
                    <td rowspan="2"><strong>Logging</strong></td>
                    <td>winston</td>
                    <td>Logging library</td>
                  </tr>
                  <tr>
                    <td>morgan</td>
                    <td>HTTP request logger</td>
                  </tr>
                  <tr>
                    <td rowspan="2"><strong>Real-time</strong></td>
                    <td>socket.io</td>
                    <td>WebSocket communication</td>
                  </tr>
                  <tr>
                    <td>ws</td>
                    <td>WebSocket client/server</td>
                  </tr>
                  <tr>
                    <td rowspan="2"><strong>Documentation</strong></td>
                    <td>swagger-jsdoc</td>
                    <td>Generate Swagger docs</td>
                  </tr>
                  <tr>
                    <td>swagger-ui-express</td>
                    <td>Serve Swagger UI</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
  <script>
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.querySelector('.sidebar-overlay');
      sidebar.classList.toggle('active');
      overlay.classList.toggle('active');
    }
    function closeSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.querySelector('.sidebar-overlay');
      sidebar.classList.remove('active');
      overlay.classList.remove('active');
    }
    // Close sidebar when clicking a link
    document.querySelectorAll('.sidebar a').forEach(link => {
      link.addEventListener('click', () => {
        closeSidebar();
      });
    });
  </script>
  <!-- Shared JavaScript for dark mode and features -->
  <script src="../assets/js/main.js"></script>
</body>
</html>



